{% extends 'base.html' %}
{% load cloudflare_images %}

{% block title %}{% if blog.meta_title %}{{ blog.meta_title }}{% else %}{{ blog.title }} - HygGeo{% endif %}{% endblock %}

{% block extra_head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{% if blog.meta_description %}{{ blog.meta_description }}{% else %}{{ blog.excerpt }}{% endif %}">
<meta name="keywords" content="{% if blog.tags %}{% for tag in blog.tags %}{{ tag }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}">
<meta name="author" content="{{ blog.author.username }}">
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{% if blog.meta_title %}{{ blog.meta_title }}{% else %}{{ blog.title }}{% endif %}">
<meta property="og:description" content="{% if blog.meta_description %}{{ blog.meta_description }}{% else %}{{ blog.excerpt }}{% endif %}">
<meta property="og:site_name" content="HygGeo">
{% if blog.featured_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ blog.featured_image.url|cf_image:'format=webp,width=1200,quality=80,fit=cover' }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
{% endif %}
<meta property="article:published_time" content="{{ blog.published_at|date:'c' }}">
<meta property="article:author" content="{{ blog.author.username }}">
{% if blog.updated_at %}
<meta property="article:modified_time" content="{{ blog.updated_at|date:'c' }}">
{% endif %}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ request.build_absolute_uri }}">
<meta name="twitter:title" content="{% if blog.meta_title %}{{ blog.meta_title }}{% else %}{{ blog.title }}{% endif %}">
<meta name="twitter:description" content="{% if blog.meta_description %}{{ blog.meta_description }}{% else %}{{ blog.excerpt }}{% endif %}">
{% if blog.featured_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ blog.featured_image.url|cf_image:'format=webp,width=1200,quality=80,fit=cover' }}">
{% endif %}

<!-- Preload LCP (featured image) -->
{% if blog.featured_image %}
<link rel="preload" as="image" href="{{ blog.featured_image.url|cf_image:'format=webp,width=1280,quality=75,fit=cover' }}" fetchpriority="high">
{% endif %}

<!-- Canonical URL -->
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Structured Data - BlogPosting -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ blog.title|escapejs }}",
  "description": "{% if blog.meta_description %}{{ blog.meta_description|escapejs }}{% else %}{{ blog.excerpt|escapejs }}{% endif %}",
  "author": {
    "@type": "Person",
    "name": "{{ blog.author.username|escapejs }}"
  },
  "datePublished": "{{ blog.published_at|date:'c' }}",
  {% if blog.updated_at %}
  "dateModified": "{{ blog.updated_at|date:'c' }}",
  {% endif %}
  {% if blog.featured_image %}
  "image": "{{ request.scheme }}://{{ request.get_host }}{{ blog.featured_image.url|cf_image:'format=webp,width=1200,quality=80,fit=cover' }}",
  {% endif %}
  "publisher": {
    "@type": "Organization",
    "name": "HygGeo",
    "url": "{{ request.scheme }}://{{ request.get_host }}"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="blog-detail-page">
    <!-- Featured Image Hero -->
    {% if blog.featured_image %}
    <div class="blog-hero-image">
        <img src="{{ blog.featured_image.url|cf_image:'format=webp,width=1920,quality=80,fit=cover' }}"
             alt="{{ blog.title }}"
             loading="eager"
             fetchpriority="high"
             class="hero-image">
        <div class="hero-overlay"></div>
    </div>
    {% endif %}

    <!-- Breadcrumb -->
    <div class="breadcrumb-section">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'experiences:blog_feed' %}">Blogs</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ blog.title|truncatewords:5 }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container py-5">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <article class="blog-article">
                    <!-- Article Header -->
                    <header class="article-header mb-4">
                        <h1 class="article-title mb-3">{{ blog.title }}</h1>

                        <div class="article-meta d-flex flex-wrap gap-3 mb-3">
                            <a href="{% url 'experiences:blog_feed' %}?author={{ blog.author.username }}" class="author-link">
                                <i class="fas fa-user-circle me-1"></i>
                                <span>{{ blog.author.username }}</span>
                            </a>
                            <span class="meta-item">
                                <i class="fas fa-calendar me-1"></i>
                                {{ blog.published_at|date:"F d, Y" }}
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-clock me-1"></i>
                                {{ blog.get_reading_time }} min read
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-eye me-1"></i>
                                {{ blog.views_count }} views
                            </span>
                        </div>

                        {% if blog.tags %}
                        <div class="article-tags d-flex flex-wrap gap-2">
                            {% for tag in blog.tags %}
                            <a href="{% url 'experiences:blog_feed' %}?tag={{ tag }}" class="tag-badge">{{ tag }}</a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </header>

                    <!-- Article Content -->
                    <div class="article-content">
                        {{ blog.content|safe }}
                    </div>

                    <!-- Featured Links -->
                    {% if blog.experience or blog.accommodation or blog.destination %}
                    <div class="featured-section mt-5">
                        <h3 class="section-title mb-3">Featured in this Post</h3>
                        <div class="row g-3">
                            {% if blog.experience %}
                            <div class="col-md-6">
                                <a href="{% url 'experiences:experience_detail' blog.experience.slug %}" class="featured-card">
                                    <div class="featured-icon experience-icon">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="featured-info">
                                        <span class="featured-label">Experience</span>
                                        <h4 class="featured-title">{{ blog.experience.title }}</h4>
                                    </div>
                                    <i class="fas fa-arrow-right arrow-icon"></i>
                                </a>
                            </div>
                            {% endif %}
                            {% if blog.accommodation %}
                            <div class="col-md-6">
                                <a href="{% url 'experiences:accommodation_detail' blog.accommodation.slug %}" class="featured-card">
                                    <div class="featured-icon accommodation-icon">
                                        <i class="fas fa-bed"></i>
                                    </div>
                                    <div class="featured-info">
                                        <span class="featured-label">Accommodation</span>
                                        <h4 class="featured-title">{{ blog.accommodation.name }}</h4>
                                    </div>
                                    <i class="fas fa-arrow-right arrow-icon"></i>
                                </a>
                            </div>
                            {% endif %}
                            {% if blog.destination %}
                            <div class="col-md-6">
                                <a href="{% url 'experiences:destination_detail' blog.destination.slug %}" class="featured-card">
                                    <div class="featured-icon destination-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="featured-info">
                                        <span class="featured-label">Destination</span>
                                        <h4 class="featured-title">{{ blog.destination.name }}</h4>
                                    </div>
                                    <i class="fas fa-arrow-right arrow-icon"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Author Actions -->
                    {% if user == blog.author %}
                    <div class="author-actions mt-4 p-3">
                        <h4 class="mb-3">Manage Your Post</h4>
                        <div class="d-flex gap-2">
                            <a href="{% url 'experiences:edit_blog' blog.slug %}" class="btn btn-edit">
                                <i class="fas fa-edit me-1"></i> Edit Post
                            </a>
                            <a href="{% url 'experiences:delete_blog' blog.slug %}" class="btn btn-delete">
                                <i class="fas fa-trash me-1"></i> Delete Post
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comments Section -->
                    <section class="comments-section mt-5">
                        <h3 class="section-title mb-4">Comments ({{ comments.count }})</h3>

                        {% if user.is_authenticated %}
                        <form method="post" class="comment-form mb-4">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ comment_form.content }}
                                {% if comment_form.content.errors %}
                                <div class="text-danger mt-2">{{ comment_form.content.errors }}</div>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-submit">
                                <i class="fas fa-paper-plane me-1"></i> Post Comment
                            </button>
                        </form>
                        {% else %}
                        <div class="comment-login-prompt text-center py-4 mb-4">
                            <i class="fas fa-lock fa-2x mb-2"></i>
                            <p class="mb-0"><a href="{% url 'login' %}">Log in</a> to join the conversation</p>
                        </div>
                        {% endif %}

                        <div class="comments-list">
                            {% for comment in comments %}
                            <div class="comment-item">
                                <div class="comment-header d-flex justify-content-between align-items-center mb-2">
                                    <strong class="comment-author">{{ comment.author.username }}</strong>
                                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="comment-content mb-0">{{ comment.content }}</p>
                            </div>
                            {% empty %}
                            <div class="empty-comments text-center py-4">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
                            </div>
                            {% endfor %}
                        </div>
                    </section>
                </article>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <aside class="blog-sidebar">
                    <!-- Like Card -->
                    <div class="sidebar-card mb-4">
                        <h4 class="sidebar-title">Like this post?</h4>
                        {% if user.is_authenticated %}
                        <form action="{% url 'experiences:like_blog' blog.slug %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-like w-100 {% if user_liked %}liked{% endif %}">
                                <i class="fas fa-heart me-2"></i>
                                <span>{% if user_liked %}Liked{% else %}Like this post{% endif %}</span>
                            </button>
                        </form>
                        <p class="like-count mt-2 mb-0">{{ blog.likes_count }} {% if blog.likes_count == 1 %}person{% else %}people{% endif %} liked this</p>
                        {% else %}
                        <div class="like-info text-center py-3">
                            <i class="fas fa-heart fa-2x mb-2"></i>
                            <p class="mb-0">{{ blog.likes_count }} likes</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Author Card -->
                    <div class="sidebar-card mb-4">
                        <h4 class="sidebar-title">About the Author</h4>
                        <p class="author-name mb-2">{{ blog.author.username }}</p>
                        <a href="{% url 'experiences:blog_feed' %}?author={{ blog.author.username }}" class="btn btn-author-posts w-100">
                            <i class="fas fa-book-open me-1"></i>
                            More from {{ blog.author.username }}
                        </a>
                    </div>

                    <!-- Related Blogs -->
                    {% if related_blogs %}
                    <div class="sidebar-card">
                        <h4 class="sidebar-title">Related Stories</h4>
                        <div class="related-list">
                            {% for related in related_blogs %}
                            <a href="{% url 'experiences:blog_detail' related.slug %}" class="related-item">
                                <h5 class="related-title">{{ related.title }}</h5>
                                <p class="related-author mb-0">By {{ related.author.username }}</p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </aside>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== HYGGEO BLOG DETAIL DESIGN ===== */

/* Page Container */
.blog-detail-page {
    background: #faf8f5;
    min-height: 100vh;
}

/* Hero Image */
.blog-hero-image {
    position: relative;
    height: 400px;
    overflow: hidden;
    background: #f3f4f6;
}

.blog-hero-image .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.blog-hero-image .hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.5) 100%);
}

/* Breadcrumb */
.breadcrumb-section {
    background: white;
    padding: 1rem 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.breadcrumb {
    font-size: 0.875rem;
    font-family: 'Poppins', sans-serif;
}

.breadcrumb-item a {
    color: #2d5a3d;
    text-decoration: none;
    font-weight: 500;
}

.breadcrumb-item a:hover {
    color: #1e4029;
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: #6b7280;
}

/* Article */
.blog-article {
    background: white;
    border-radius: 12px;
    padding: 2.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.article-title {
    font-size: 2.5rem;
    font-weight: 600;
    color: #1a1a1a;
    line-height: 1.2;
    font-family: 'Poppins', sans-serif;
}

.article-meta {
    font-size: 0.9375rem;
    color: #6b7280;
    font-weight: 500;
}

.author-link {
    color: #2d5a3d;
    text-decoration: none;
    font-weight: 600;
}

.author-link:hover {
    color: #1e4029;
}

.meta-item {
    display: flex;
    align-items: center;
}

.article-tags .tag-badge {
    background: #f0f7f4;
    color: #2d5a3d;
    padding: 0.375rem 0.875rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.article-tags .tag-badge:hover {
    background: #2d5a3d;
    color: white;
}

/* Article Content */
.article-content {
    font-size: 1.125rem;
    line-height: 1.75;
    color: #374151;
    font-family: 'Poppins', sans-serif;
}

.article-content p {
    margin-bottom: 1.5rem;
}

.article-content h2 {
    font-size: 2rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
}

.article-content h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
}

.article-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
}

.article-content a {
    color: #2d5a3d;
    font-weight: 600;
}

.article-content a:hover {
    color: #1e4029;
}

.article-content ul,
.article-content ol {
    margin: 1.25rem 0;
    padding-left: 1.5rem;
}

.article-content li {
    margin-bottom: 0.5rem;
}

.article-content blockquote {
    border-left: 4px solid #2d5a3d;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #6b7280;
}

/* Featured Section */
.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2d5a3d;
    font-family: 'Poppins', sans-serif;
}

.featured-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: #f9fafb;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
}

.featured-card:hover {
    background: #f0f7f4;
    transform: translateX(4px);
    border-color: #2d5a3d;
}

.featured-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.experience-icon {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
}

.accommodation-icon {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
}

.destination-icon {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.featured-info {
    flex: 1;
}

.featured-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #9ca3af;
    margin-bottom: 0.25rem;
}

.featured-title {
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
}

.arrow-icon {
    color: #d1d5db;
    transition: transform 0.3s ease;
}

.featured-card:hover .arrow-icon {
    transform: translateX(4px);
    color: #2d5a3d;
}

/* Author Actions */
.author-actions {
    background: #fef3c7;
    border-radius: 10px;
    border-left: 4px solid #f59e0b;
}

.author-actions h4 {
    color: #92400e;
    font-size: 1.125rem;
    font-weight: 600;
}

.btn-edit {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-edit:hover {
    background: #2563eb;
    transform: translateY(-1px);
    color: white;
}

.btn-delete {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-delete:hover {
    background: #dc2626;
    transform: translateY(-1px);
    color: white;
}

/* Comments Section */
.comment-form textarea {
    width: 100%;
    padding: 0.875rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: 'Poppins', sans-serif;
    resize: vertical;
    min-height: 100px;
}

.comment-form textarea:focus {
    outline: none;
    border-color: #2d5a3d;
    box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1);
}

.btn-submit {
    background: #2d5a3d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-submit:hover {
    background: #1e4029;
    transform: translateY(-1px);
    color: white;
}

.comment-login-prompt {
    background: #f9fafb;
    border-radius: 8px;
    color: #6b7280;
}

.comment-login-prompt a {
    color: #2d5a3d;
    font-weight: 600;
}

.comment-item {
    padding: 1.25rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-author {
    color: #111827;
    font-weight: 600;
}

.comment-time {
    color: #9ca3af;
    font-size: 0.875rem;
}

.comment-content {
    color: #4b5563;
    line-height: 1.6;
}

.empty-comments {
    color: #9ca3af;
}

/* Sidebar */
.blog-sidebar {
    position: sticky;
    top: 2rem;
}

.sidebar-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.sidebar-title {
    font-size: 1rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 1rem;
    font-family: 'Poppins', sans-serif;
}

.btn-like {
    padding: 0.875rem;
    background: #f3f4f6;
    color: #374151;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-like:hover {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #dc2626;
}

.btn-like.liked {
    background: #2d5a3d;
    color: white;
    border-color: #2d5a3d;
}

.like-count {
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
}

.like-info {
    color: #6b7280;
}

.author-name {
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
}

.btn-author-posts {
    padding: 0.625rem 1.125rem;
    background: #f0f7f4;
    color: #2d5a3d;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-author-posts:hover {
    background: #2d5a3d;
    color: white;
}

.related-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.related-item {
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid #f3f4f6;
}

.related-item:hover {
    background: #f0f7f4;
    border-color: #2d5a3d;
}

.related-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
    line-height: 1.4;
}

.related-author {
    font-size: 0.8125rem;
    color: #6b7280;
}

/* Responsive */
@media (max-width: 992px) {
    .blog-sidebar {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .blog-hero-image {
        height: 300px;
    }

    .blog-article {
        padding: 1.5rem;
    }

    .article-title {
        font-size: 1.875rem;
    }

    .article-content {
        font-size: 1rem;
    }

    .author-actions {
        padding: 1rem;
    }
}
</style>
{% endblock %}
