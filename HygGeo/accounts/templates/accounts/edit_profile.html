{% extends 'base.html' %}

{% block title %}Edit Profile - HygGeo{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <i class="fas fa-user-edit text-primary" style="font-size: 3rem;"></i>
                <h2 class="h3 fw-bold mt-3" style="color: var(--hygge-green);">Edit Your Profile</h2>
                <p class="text-muted">Update your information and travel preferences</p>
            </div>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="card card-hygge mb-4">
                    <div class="card-header" style="background-color: var(--hygge-cream); border-bottom: none;">
                        <h5 class="mb-0 fw-bold" style="color: var(--hygge-green);">
                            <i class="fas fa-info-circle me-2"></i>Basic Information
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ user_form.first_name.id_for_label }}" class="form-label fw-bold">First Name</label>
                                <input type="text" name="first_name" class="form-control" id="{{ user_form.first_name.id_for_label }}" value="{{ user_form.first_name.value|default:'' }}">
                                {% if user_form.first_name.errors %}
                                    <div class="text-danger small">{{ user_form.first_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ user_form.last_name.id_for_label }}" class="form-label fw-bold">Last Name</label>
                                <input type="text" name="last_name" class="form-control" id="{{ user_form.last_name.id_for_label }}" value="{{ user_form.last_name.value|default:'' }}">
                                {% if user_form.last_name.errors %}
                                    <div class="text-danger small">{{ user_form.last_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ user_form.email.id_for_label }}" class="form-label fw-bold">Email Address</label>
                            <input type="email" name="email" class="form-control" id="{{ user_form.email.id_for_label }}" value="{{ user_form.email.value|default:'' }}">
                            {% if user_form.email.errors %}
                                <div class="text-danger small">{{ user_form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Profile Details -->
                <div class="card card-hygge mb-4">
                    <div class="card-header" style="background-color: var(--hygge-cream); border-bottom: none;">
                        <h5 class="mb-0 fw-bold" style="color: var(--hygge-green);">
                            <i class="fas fa-user-circle me-2"></i>Profile Details
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label for="{{ profile_form.location.id_for_label }}" class="form-label fw-bold">Location</label>
                            <input type="text" name="location" class="form-control" id="{{ profile_form.location.id_for_label }}" value="{{ profile_form.location.value|default:'' }}" placeholder="e.g., Seattle, WA">
                            {% if profile_form.location.errors %}
                                <div class="text-danger small">{{ profile_form.location.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ profile_form.bio.id_for_label }}" class="form-label fw-bold">Bio</label>
                            <textarea name="bio" class="form-control" id="{{ profile_form.bio.id_for_label }}" rows="4" placeholder="Tell us about yourself and your travel philosophy...">{{ profile_form.bio.value|default:'' }}</textarea>
                            {% if profile_form.bio.errors %}
                                <div class="text-danger small">{{ profile_form.bio.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ profile_form.avatar.id_for_label }}" class="form-label fw-bold">Profile Picture</label>

                            <!-- Current Avatar Preview -->
                            {% if user.userprofile.avatar %}
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <img src="{{ user.userprofile.avatar.url }}" alt="Current profile picture" class="rounded-circle me-3" id="currentAvatar" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--hygge-light-green);">
                                    <div>
                                        <p class="mb-1 fw-semibold text-success">
                                            <i class="fas fa-check-circle me-1"></i>Current Profile Picture
                                        </p>
                                        <small class="text-muted">Upload a new image to replace</small>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" id="avatarPlaceholder" style="width: 80px; height: 80px; background-color: var(--hygge-cream); border: 2px dashed var(--hygge-green);">
                                        <i class="fas fa-camera text-muted" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <p class="mb-1 fw-semibold" style="color: var(--hygge-green);">
                                            <i class="fas fa-plus-circle me-1"></i>Add Profile Picture
                                        </p>
                                        <small class="text-muted">Help others recognize you in the community</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- File Input -->
                            <div class="mb-2">
                                <input type="file" name="avatar" class="form-control" id="{{ profile_form.avatar.id_for_label }}" accept="image/*">
                                {% if profile_form.avatar.errors %}
                                    <div class="text-danger small">{{ profile_form.avatar.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Preview Area for New Upload -->
                            <div id="imagePreview" class="mb-2" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <img id="previewImg" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--hygge-green);">
                                    <div>
                                        <p class="mb-1 fw-semibold text-primary">
                                            <i class="fas fa-eye me-1"></i>Preview - New Profile Picture
                                        </p>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="removePreview">
                                            <i class="fas fa-times me-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Upload JPG, PNG, or GIF images. Max size: 2MB. Square images work best.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Travel Preferences -->
                <div class="card card-hygge mb-4">
                    <div class="card-header" style="background-color: var(--hygge-cream); border-bottom: none;">
                        <h5 class="mb-0 fw-bold" style="color: var(--hygge-green);">
                            <i class="fas fa-leaf me-2"></i>Sustainability Preferences
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label for="{{ profile_form.sustainability_priority.id_for_label }}" class="form-label fw-bold">
                                How important is sustainability in your travel decisions?
                            </label>
                            <select name="sustainability_priority" class="form-control" id="{{ profile_form.sustainability_priority.id_for_label }}">
                                <option value="1" {% if profile_form.sustainability_priority.value == 1 %}selected{% endif %}>Low</option>
                                <option value="2" {% if profile_form.sustainability_priority.value == 2 %}selected{% endif %}>Medium</option>
                                <option value="3" {% if profile_form.sustainability_priority.value == 3 %}selected{% endif %}>High</option>
                                <option value="4" {% if profile_form.sustainability_priority.value == 4 %}selected{% endif %}>Very High</option>
                                <option value="5" {% if profile_form.sustainability_priority.value == 5 %}selected{% endif %}>Essential</option>
                            </select>
                            {% if profile_form.sustainability_priority.errors %}
                                <div class="text-danger small">{{ profile_form.sustainability_priority.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="card card-hygge mb-4">
                    <div class="card-header" style="background-color: var(--hygge-cream); border-bottom: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold" style="color: var(--hygge-green);">
                                <i class="fas fa-lock me-2"></i>Change Password
                            </h5>
                            <small class="text-muted">(Leave blank to keep current password)</small>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_current_password" class="form-label fw-bold">Current Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="id_current_password" name="current_password" placeholder="Enter current password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">Required only if changing password</small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="p-3 rounded" style="background-color: var(--hygge-cream);">
                                    <h6 class="fw-semibold mb-2" style="color: var(--hygge-green);">
                                        <i class="fas fa-info-circle me-2"></i>Password Requirements
                                    </h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li><i class="fas fa-check text-success me-2"></i>At least 8 characters</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Mix of letters and numbers</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Include symbols (recommended)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_new_password1" class="form-label fw-bold">New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="id_new_password1" name="new_password1" placeholder="Enter new password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength" id="passwordStrength" style="display: none;">
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar" id="strengthBar"></div>
                                    </div>
                                    <small class="text-muted" id="strengthText"></small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_new_password2" class="form-label fw-bold">Confirm New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="id_new_password2" name="new_password2" placeholder="Confirm new password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div id="passwordMatch" style="display: none;">
                                    <small class="text-muted mt-1 d-block" id="matchText"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fas fa-shield-alt me-2"></i>
                            <small>Your password is encrypted and stored securely. We never store passwords in plain text.</small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center">
                    <button type="submit" class="btn btn-hygge btn-lg px-5 py-3 me-3">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <a href="{% url 'profile' %}" class="btn btn-outline-secondary btn-lg px-5 py-3">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.form-control:focus {
    border-color: var(--hygge-light-green);
    box-shadow: 0 0 0 0.2rem rgba(74, 124, 89, 0.25);
}

.card-hygge {
    transition: transform 0.3s ease;
}

.card-hygge:hover {
    transform: translateY(-2px);
}

textarea {
    resize: vertical;
}

/* Password strength indicators */
.progress-bar.weak {
    background-color: #dc3545;
}

.progress-bar.fair {
    background-color: #ffc107;
}

.progress-bar.good {
    background-color: #17a2b8;
}

.progress-bar.strong {
    background-color: #28a745;
}

.text-weak {
    color: #dc3545;
}

.text-fair {
    color: #ffc107;
}

.text-good {
    color: #17a2b8;
}

.text-strong {
    color: #28a745;
}

.input-group .btn-outline-secondary:hover {
    background-color: var(--hygge-green);
    border-color: var(--hygge-green);
    color: white;
}

/* Form validation states */
.form-control.is-invalid {
    border-color: #dc3545;
}

.form-control.is-valid {
    border-color: #28a745;
}
</style>

<script>
// Enhanced image preview functionality
document.querySelector('input[type="file"]').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const currentAvatar = document.getElementById('currentAvatar');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');

    if (file && file.type.startsWith('image/')) {
        // Check file size (2MB limit)
        if (file.size > 2 * 1024 * 1024) {
            alert('File size too large. Please select an image smaller than 2MB.');
            this.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewDiv.style.display = 'block';

            // Hide current avatar or placeholder
            if (currentAvatar) {
                currentAvatar.parentElement.parentElement.style.opacity = '0.5';
            }
            if (avatarPlaceholder) {
                avatarPlaceholder.parentElement.parentElement.style.opacity = '0.5';
            }

            // Add upload animation
            previewDiv.style.opacity = '0';
            previewDiv.style.transform = 'scale(0.8)';

            setTimeout(() => {
                previewDiv.style.transition = 'all 0.3s ease';
                previewDiv.style.opacity = '1';
                previewDiv.style.transform = 'scale(1)';
            }, 50);
        };
        reader.readAsDataURL(file);
    } else {
        previewDiv.style.display = 'none';

        // Restore original avatar or placeholder opacity
        if (currentAvatar) {
            currentAvatar.parentElement.parentElement.style.opacity = '1';
        }
        if (avatarPlaceholder) {
            avatarPlaceholder.parentElement.parentElement.style.opacity = '1';
        }
    }
});

// Remove preview functionality
document.getElementById('removePreview')?.addEventListener('click', function() {
    const fileInput = document.querySelector('input[type="file"]');
    const previewDiv = document.getElementById('imagePreview');
    const currentAvatar = document.getElementById('currentAvatar');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');

    fileInput.value = '';
    previewDiv.style.display = 'none';

    // Restore original avatar or placeholder opacity
    if (currentAvatar) {
        currentAvatar.parentElement.parentElement.style.opacity = '1';
    }
    if (avatarPlaceholder) {
        avatarPlaceholder.parentElement.parentElement.style.opacity = '1';
    }
});

// Add subtle animations
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card-hygge');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Password visibility toggles
    const toggleButtons = [
        { button: 'toggleCurrentPassword', input: 'id_current_password' },
        { button: 'toggleNewPassword1', input: 'id_new_password1' },
        { button: 'toggleNewPassword2', input: 'id_new_password2' }
    ];
    
    toggleButtons.forEach(({ button, input }) => {
        const toggleBtn = document.getElementById(button);
        const passwordInput = document.getElementById(input);
        
        if (toggleBtn && passwordInput) {
            toggleBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                const icon = toggleBtn.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }
    });
    
    // Password strength checker
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    const strengthDiv = document.getElementById('passwordStrength');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const matchDiv = document.getElementById('passwordMatch');
    const matchText = document.getElementById('matchText');
    
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/)) strength++;
        if (password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;
        
        strengthBar.classList.remove('weak', 'fair', 'good', 'strong');
        strengthText.classList.remove('text-weak', 'text-fair', 'text-good', 'text-strong');
        
        switch(strength) {
            case 0:
            case 1:
                strengthBar.style.width = '20%';
                strengthBar.classList.add('weak');
                strengthText.classList.add('text-weak');
                feedback = 'Very Weak';
                break;
            case 2:
                strengthBar.style.width = '40%';
                strengthBar.classList.add('fair');
                strengthText.classList.add('text-fair');
                feedback = 'Weak';
                break;
            case 3:
                strengthBar.style.width = '60%';
                strengthBar.classList.add('fair');
                strengthText.classList.add('text-fair');
                feedback = 'Fair';
                break;
            case 4:
                strengthBar.style.width = '80%';
                strengthBar.classList.add('good');
                strengthText.classList.add('text-good');
                feedback = 'Good';
                break;
            case 5:
                strengthBar.style.width = '100%';
                strengthBar.classList.add('strong');
                strengthText.classList.add('text-strong');
                feedback = 'Strong';
                break;
        }
        
        strengthText.textContent = feedback;
        return strength;
    }
    
    function checkPasswordMatch() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;
        
        if (password2) {
            matchDiv.style.display = 'block';
            if (password1 === password2) {
                newPassword2.classList.remove('is-invalid');
                newPassword2.classList.add('is-valid');
                matchText.textContent = 'Passwords match';
                matchText.className = 'text-success mt-1 d-block';
            } else {
                newPassword2.classList.remove('is-valid');
                newPassword2.classList.add('is-invalid');
                matchText.textContent = 'Passwords do not match';
                matchText.className = 'text-danger mt-1 d-block';
            }
        } else {
            matchDiv.style.display = 'none';
            newPassword2.classList.remove('is-valid', 'is-invalid');
        }
    }
    
    newPassword1.addEventListener('input', function() {
        const password = this.value;
        
        if (password) {
            strengthDiv.style.display = 'block';
            const strength = checkPasswordStrength(password);
            
            // Update input validation state
            if (strength >= 3) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        } else {
            strengthDiv.style.display = 'none';
            this.classList.remove('is-valid', 'is-invalid');
        }
        
        checkPasswordMatch();
    });
    
    newPassword2.addEventListener('input', checkPasswordMatch);
    
    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const currentPassword = document.getElementById('id_current_password').value;
        const newPassword1 = document.getElementById('id_new_password1').value;
        const newPassword2 = document.getElementById('id_new_password2').value;
        
        // If any password field is filled, all must be filled
        if (currentPassword || newPassword1 || newPassword2) {
            if (!currentPassword) {
                e.preventDefault();
                alert('Current password is required when changing password.');
                return false;
            }
            
            if (!newPassword1 || !newPassword2) {
                e.preventDefault();
                alert('Please fill in both new password fields.');
                return false;
            }
            
            if (newPassword1 !== newPassword2) {
                e.preventDefault();
                alert('New passwords do not match.');
                return false;
            }
            
            if (newPassword1.length < 8) {
                e.preventDefault();
                alert('New password must be at least 8 characters long.');
                return false;
            }
        }
    });
});
</script>
{% endblock %}