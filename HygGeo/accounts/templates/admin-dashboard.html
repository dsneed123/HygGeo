{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - {{ block.super }}{% endblock %}

{% block extra_head %}
<!-- Google Fonts for Social Media Generator -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <i class="fas fa-cogs text-primary mb-3" style="font-size: 4rem; color: var(--hygge-green) !important;"></i>
                <h1 class="h2 fw-bold" style="color: var(--hygge-green);">HygGeo Admin Dashboard</h1>
                <p class="lead text-muted">Manage experiences, destinations, and content</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card card-hygge h-100">
                <div class="card-body text-center">
                    <i class="fas fa-map-marked-alt text-primary mb-3" style="font-size: 2.5rem; color: var(--hygge-green) !important;"></i>
                    <h4 class="fw-bold">{{ stats.experiences_count }}</h4>
                    <p class="text-muted mb-0">Total Experiences</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-hygge h-100">
                <div class="card-body text-center">
                    <i class="fas fa-bed text-info mb-3" style="font-size: 2.5rem; color: #9b59b6 !important;"></i>
                    <h4 class="fw-bold">{{ stats.accommodations_count }}</h4>
                    <p class="text-muted mb-0">Accommodations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-hygge h-100">
                <div class="card-body text-center">
                    <i class="fas fa-globe-americas text-info mb-3" style="font-size: 2.5rem; color: var(--hygge-soft-blue) !important;"></i>
                    <h4 class="fw-bold">{{ stats.destinations_count }}</h4>
                    <p class="text-muted mb-0">Destinations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card card-hygge h-100">
                <div class="card-body text-center">
                    <i class="fas fa-building text-warning mb-3" style="font-size: 2.5rem; color: var(--hygge-gold) !important;"></i>
                    <h4 class="fw-bold">{{ stats.providers_count }}</h4>
                    <p class="text-muted mb-0">Providers</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Stats Row -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card card-hygge h-100">
                <div class="card-body text-center">
                    <i class="fas fa-users text-success mb-3" style="font-size: 2.5rem; color: var(--hygge-light-green) !important;"></i>
                    <h4 class="fw-bold">{{ stats.users_count }}</h4>
                    <p class="text-muted mb-0">Registered Users</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Actions Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-plus-circle me-2"></i>Add New Content
            </h3>
        </div>
    </div>

    <!-- Add Content Cards -->
    <div class="row mb-5">
        <!-- Add Experience -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-star" style="font-size: 3rem; color: var(--hygge-green);"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Experience</h5>
                    <p class="text-muted mb-4">Create a new travel experience with full details, pricing, and categorization.</p>
                    <a href="{% url 'experiences:add_experience' %}" class="btn btn-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Experience
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Destination -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: var(--hygge-soft-blue);"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Destination</h5>
                    <p class="text-muted mb-4">Add a new travel destination with location details and sustainability information.</p>
                    <a href="{% url 'experiences:add_destination' %}" class="btn btn-outline-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Destination
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Provider -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-handshake" style="font-size: 3rem; color: var(--hygge-gold);"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Provider</h5>
                    <p class="text-muted mb-4">Register a new service provider with contact details and certifications.</p>
                    <a href="{% url 'experiences:add_provider' %}" class="btn btn-outline-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Provider
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Category -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-tags" style="font-size: 3rem; color: var(--hygge-light-green);"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Category</h5>
                    <p class="text-muted mb-4">Create a new experience category with custom icons and descriptions.</p>
                    <a href="{% url 'experiences:add_category' %}" class="btn btn-outline-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Category
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Experience Type -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-list-ul" style="font-size: 3rem; color: #e74c3c;"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Experience Type</h5>
                    <p class="text-muted mb-4">Define a new type of travel experience for better categorization.</p>
                    <a href="{% url 'experiences:add_experience_type' %}" class="btn btn-outline-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Type
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Accommodation -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-bed" style="font-size: 3rem; color: #9b59b6;"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Add Accommodation</h5>
                    <p class="text-muted mb-4">Add a new accommodation option like hotels, hostels, or eco-lodges.</p>
                    <a href="{% url 'experiences:add_accommodation' %}" class="btn btn-outline-hygge btn-lg w-100">
                        <i class="fas fa-plus me-2"></i>Add Accommodation
                    </a>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--hygge-light-green);"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Analytics Dashboard</h5>
                    <p class="text-muted mb-4">Track user engagement, content performance, and platform growth metrics.</p>
                    <a href="{% url 'analytics_dashboard' %}" class="btn btn-hygge btn-lg w-100">
                        <i class="fas fa-chart-bar me-2"></i>View Analytics
                    </a>
                </div>
            </div>
        </div>

        <!-- Task Management -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-tasks" style="font-size: 3rem; color: #e74c3c;"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Task Management</h5>
                    <p class="text-muted mb-4">Manage projects, assign tasks to team members, and track progress with calendar view.</p>
                    <a href="{% url 'task_management:dashboard' %}" class="btn btn-hygge btn-lg w-100">
                        <i class="fas fa-calendar-check me-2"></i>Manage Tasks
                    </a>
                </div>
            </div>
        </div>

        <!-- Django Admin -->
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card card-hygge h-100 admin-action-card">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="fas fa-cog" style="font-size: 3rem; color: #6f42c1;"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Django Admin</h5>
                    <p class="text-muted mb-4">Access the full Django admin interface for advanced management.</p>
                    <a href="/admin/" class="btn btn-outline-hygge btn-lg w-100" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>Open Admin
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Notifications Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-bell me-2"></i>Send Notifications to Users
            </h3>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card card-hygge">
                <div class="card-body p-4">
                    <p class="text-muted mb-4">Send system notifications to users. These will appear in their notification center.</p>

                    <form method="post" action="{% url 'send_admin_notification' %}">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="recipientType" class="form-label fw-bold">Recipients</label>
                            <select class="form-select" id="recipientType" name="recipient_type" required>
                                <option value="">Select recipient group...</option>
                                <option value="all">All Active Users</option>
                                <option value="active">Recently Active Users (Last 30 days)</option>
                                <option value="members">All Members</option>
                                <option value="staff">Staff Only (for testing)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label fw-bold">Notification Title</label>
                            <input type="text" class="form-control" id="notificationTitle" name="title"
                                   placeholder="Enter notification title" maxlength="200" required>
                            <small class="text-muted">Max 200 characters</small>
                        </div>

                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label fw-bold">Message</label>
                            <textarea class="form-control" id="notificationMessage" name="message"
                                      rows="4" placeholder="Enter notification message" required></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="notificationLink" class="form-label fw-bold">Link (Optional)</label>
                            <input type="url" class="form-control" id="notificationLink" name="link"
                                   placeholder="https://example.com/page">
                            <small class="text-muted">Optional: Link to a specific page users can visit</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-hygge btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Send Notification
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Export Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-envelope me-2"></i>Email Management
            </h3>
        </div>
    </div>

    <!-- Email Statistics and Export -->
    <div class="row mb-5">
        <!-- Email Statistics -->
        <div class="col-lg-6 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Email Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <h4 class="fw-bold text-primary">{{ email_stats.total_users }}</h4>
                                <p class="text-muted mb-0 small">Total Users</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <h4 class="fw-bold text-success">{{ email_stats.users_with_email }}</h4>
                                <p class="text-muted mb-0 small">With Email</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="fw-bold text-info">{{ email_stats.active_users }}</h4>
                                <p class="text-muted mb-0 small">Active Users</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="fw-bold text-warning">{{ email_stats.active_users_with_email }}</h4>
                                <p class="text-muted mb-0 small">Active + Email</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Management -->
        <div class="col-lg-6 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-envelope me-2"></i>Email Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-paper-plane" style="font-size: 3rem; color: var(--hygge-green);"></i>
                    </div>
                    <h6 class="fw-bold text-center mb-3">Send Template Emails</h6>
                    <p class="text-muted small text-center mb-3">Create and send personalized email campaigns to your users</p>
                    <div class="d-grid">
                        <a href="{% url 'email_management' %}" class="btn btn-hygge">
                            <i class="fas fa-envelope me-2"></i>Manage Email Templates
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Export Actions -->
        <div class="col-lg-6 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-download me-2"></i>Export User Emails
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <h6 class="fw-bold text-muted">All Users</h6>
                        <div class="row">
                            <div class="col-6">
                                <a href="{% url 'export_all_emails_csv' %}" class="btn btn-outline-primary btn-sm w-100">
                                    <i class="fas fa-file-csv me-1"></i>CSV Format
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'export_all_emails_text' %}" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="fas fa-file-alt me-1"></i>Text Format
                                </a>
                            </div>
                        </div>

                        <h6 class="fw-bold text-muted mt-3">Active Users Only</h6>
                        <div class="row">
                            <div class="col-6">
                                <a href="{% url 'export_active_emails_csv' %}" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-file-csv me-1"></i>CSV Format
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'export_active_emails_text' %}" class="btn btn-hygge btn-sm w-100">
                                    <i class="fas fa-file-alt me-1"></i>Text Format
                                </a>
                            </div>
                        </div>

                        <h6 class="fw-bold text-muted mt-3">Premium Mail Merge</h6>
                        <div class="d-grid">
                            <a href="{% url 'export_mail_merge_premium' %}" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-star me-1"></i>Premium Mail Merge Data
                            </a>
                        </div>

                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Note:</strong> All exports only include users who have consented to receive emails<br>
                                <strong>CSV:</strong> Basic details with unsubscribe links<br>
                                <strong>Text:</strong> Email list only<br>
                                <strong>Premium:</strong> Full personalization data with names, interests, recommendations, custom greetings & unsubscribe links
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Report Export -->
        <div class="col-lg-6 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-file-pdf me-2"></i>Business Analytics Report
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; color: var(--hygge-green);"></i>
                    </div>
                    <h6 class="fw-bold text-center mb-3">Comprehensive Business Report</h6>
                    <p class="text-muted small text-center mb-3">Export a complete PDF report with user analytics, content metrics, traffic data, and Google Search Console insights</p>
                    <div class="d-grid">
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#gscDataModal">
                            <i class="fas fa-file-pdf me-2"></i>Export Business Report (PDF)
                        </button>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Includes:</strong> User analytics, content stats, traffic metrics, top performers, KPIs, and Google Search Console data
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Search Console Data Modal -->
    <div class="modal fade" id="gscDataModal" tabindex="-1" aria-labelledby="gscDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--hygge-green) 0%, #357a52 100%); color: white;">
                    <h5 class="modal-title" id="gscDataModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Google Search Console Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Optional:</strong> Enter your Google Search Console metrics below for a complete report. Leave blank to generate without GSC data.
                    </div>

                    <form id="gscDataForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="fw-bold text-primary">
                                    <i class="fas fa-eye me-2"></i>Total Impressions
                                </h6>
                                <p class="small text-muted mb-3">How many times your site appeared in search results</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 7 Days</label>
                                <input type="number" class="form-control" id="impressions_7d" name="impressions_7d"
                                       placeholder="e.g., 1500">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 30 Days</label>
                                <input type="number" class="form-control" id="impressions_30d" name="impressions_30d"
                                       placeholder="e.g., 6000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 90 Days</label>
                                <input type="number" class="form-control" id="impressions_90d" name="impressions_90d"
                                       placeholder="e.g., 18000">
                            </div>

                            <div class="col-12 mt-4">
                                <h6 class="fw-bold text-primary">
                                    <i class="fas fa-sort-amount-up me-2"></i>Average Position
                                </h6>
                                <p class="small text-muted mb-3">Average ranking position in search results (lower is better)</p>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 7 Days</label>
                                <input type="number" step="0.1" class="form-control" id="position_7d" name="position_7d"
                                       placeholder="e.g., 15.3">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 30 Days</label>
                                <input type="number" step="0.1" class="form-control" id="position_30d" name="position_30d"
                                       placeholder="e.g., 14.8">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Last 90 Days</label>
                                <input type="number" step="0.1" class="form-control" id="position_90d" name="position_90d"
                                       placeholder="e.g., 16.2">
                            </div>

                            <div class="col-12 mt-4">
                                <div class="card" style="background: #f8f9fa; border-left: 4px solid #4285F4;">
                                    <div class="card-body">
                                        <h6 class="fw-bold mb-2">
                                            <i class="fas fa-lightbulb me-2" style="color: #4285F4;"></i>How to find this data:
                                        </h6>
                                        <ol class="small mb-0">
                                            <li>Go to <a href="https://search.google.com/search-console" target="_blank">search.google.com/search-console</a></li>
                                            <li>Select your property (hyggeo.com)</li>
                                            <li>Navigate to <strong>Performance > Search Results</strong></li>
                                            <li>Select the date range (Last 7, 30, or 90 days)</li>
                                            <li>View <strong>Total impressions</strong> and <strong>Average position</strong> at the top</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateReportWithGSCData()">
                        <i class="fas fa-file-pdf me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Content Management Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-star me-2"></i>Manage Featured Content
            </h3>
            <p class="text-muted mb-4">Click the star icon to toggle featured status. Featured items appear on the homepage.</p>
        </div>
    </div>

    <!-- Featured Content Tabs -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card card-hygge">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="experiences-tab" data-bs-toggle="tab" href="#experiences" role="tab">
                                <i class="fas fa-map-marked-alt me-2"></i>Experiences
                                <span class="badge bg-primary">{{ stats.featured_experiences_count }}/{{ all_experiences|length }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="accommodations-tab" data-bs-toggle="tab" href="#accommodations" role="tab">
                                <i class="fas fa-bed me-2"></i>Accommodations
                                <span class="badge bg-info">{{ stats.featured_accommodations_count }}/{{ all_accommodations|length }}</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Experiences Tab -->
                        <div class="tab-pane fade show active" id="experiences" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <input type="text" id="experienceSearch" class="form-control" placeholder="Search by title or destination...">
                                </div>
                                <div class="col-md-4">
                                    <select id="experienceFilter" class="form-control">
                                        <option value="featured">Featured Only</option>
                                        <option value="all">All Experiences</option>
                                        <option value="not-featured">Not Featured</option>
                                        <option value="active">Active Only</option>
                                        <option value="inactive">Inactive Only</option>
                                    </select>
                                </div>
                            </div>
                            <div class="alert alert-info" id="experienceCount">
                                <i class="fas fa-info-circle me-2"></i>Showing <strong id="experienceCountText">0</strong> experiences
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="60">Featured</th>
                                            <th>Title</th>
                                            <th>Destination</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                        </tr>
                                    </thead>
                                    <tbody id="experiencesTableBody">
                                        {% for exp in all_experiences %}
                                        <tr data-searchable="{{ exp.title|lower }} {{ exp.destination.name|lower }}"
                                            data-featured="{{ exp.is_featured|lower }}"
                                            data-active="{{ exp.is_active|lower }}"
                                            style="{% if not exp.is_featured %}display: none;{% endif %}">
                                            <td>
                                                <button class="btn btn-sm toggle-featured-btn {% if exp.is_featured %}btn-warning{% else %}btn-outline-secondary{% endif %}"
                                                        data-id="{{ exp.id }}"
                                                        data-type="experience"
                                                        data-featured="{{ exp.is_featured|lower }}"
                                                        title="{% if exp.is_featured %}Remove from featured{% else %}Add to featured{% endif %}">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                            </td>
                                            <td>
                                                <strong>{{ exp.title }}</strong>
                                                <br><small class="text-muted">{{ exp.description|truncatewords:10 }}</small>
                                            </td>
                                            <td>{{ exp.destination.name }}</td>
                                            <td>
                                                {% if exp.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ exp.created_at|date:"M d, Y" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr id="experienceNoResults">
                                            <td colspan="5" class="text-center text-muted">No experiences found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Accommodations Tab -->
                        <div class="tab-pane fade" id="accommodations" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <input type="text" id="accommodationSearch" class="form-control" placeholder="Search by name or destination...">
                                </div>
                                <div class="col-md-4">
                                    <select id="accommodationFilter" class="form-control">
                                        <option value="featured">Featured Only</option>
                                        <option value="all">All Accommodations</option>
                                        <option value="not-featured">Not Featured</option>
                                        <option value="active">Active Only</option>
                                        <option value="inactive">Inactive Only</option>
                                    </select>
                                </div>
                            </div>
                            <div class="alert alert-info" id="accommodationCount">
                                <i class="fas fa-info-circle me-2"></i>Showing <strong id="accommodationCountText">0</strong> accommodations
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="60">Featured</th>
                                            <th>Name</th>
                                            <th>Destination</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accommodationsTableBody">
                                        {% for acc in all_accommodations %}
                                        <tr data-searchable="{{ acc.name|lower }} {{ acc.destination.name|lower }}"
                                            data-featured="{{ acc.is_featured|lower }}"
                                            data-active="{{ acc.is_active|lower }}"
                                            style="{% if not acc.is_featured %}display: none;{% endif %}">
                                            <td>
                                                <button class="btn btn-sm toggle-featured-btn {% if acc.is_featured %}btn-warning{% else %}btn-outline-secondary{% endif %}"
                                                        data-id="{{ acc.id }}"
                                                        data-type="accommodation"
                                                        data-featured="{{ acc.is_featured|lower }}"
                                                        title="{% if acc.is_featured %}Remove from featured{% else %}Add to featured{% endif %}">
                                                    <i class="fas fa-star"></i>
                                                </button>
                                            </td>
                                            <td>
                                                <strong>{{ acc.name }}</strong>
                                                <br><small class="text-muted">{{ acc.short_description|truncatewords:10 }}</small>
                                            </td>
                                            <td>{{ acc.destination.name }}</td>
                                            <td>{{ acc.get_accommodation_type_display }}</td>
                                            <td>
                                                {% if acc.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr id="accommodationNoResults">
                                            <td colspan="5" class="text-center text-muted">No accommodations found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 10 Blog Generator Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-magic me-2"></i>Top 10 Blog Generator
            </h3>
            <p class="text-muted mb-4">Automatically generate "Top 10" style blog posts with experiences and accommodations</p>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card card-hygge">
                <div class="card-body p-4">
                    <form id="blogGeneratorForm" method="POST" action="{% url 'generate_top_10_blog' %}">
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- Step 1: Basic Settings -->
                            <div class="col-12">
                                <h5 class="fw-bold mb-3" style="color: var(--hygge-green);">
                                    <i class="fas fa-cog me-2"></i>Step 1: Basic Settings
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Blog Type</label>
                                <select name="blog_type" id="blogType" class="form-select" required onchange="updateItemSelection()">
                                    <option value="experiences">Top Experiences</option>
                                    <option value="accommodations">Top Accommodations</option>
                                    <option value="mixed">Mixed (Experiences + Accommodations)</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Destination</label>
                                <select name="destination" id="destinationSelect" class="form-select" required onchange="loadItemsForDestination()">
                                    <option value="">Select Destination...</option>
                                    {% for dest in all_destinations %}
                                    <option value="{{ dest.id }}">{{ dest.name }}, {{ dest.country }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Step 2: SEO Title Template -->
                            <div class="col-12 mt-4">
                                <h5 class="fw-bold mb-3" style="color: var(--hygge-green);">
                                    <i class="fas fa-search me-2"></i>Step 2: SEO Title Template
                                </h5>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Title Template (SEO Optimized)</label>
                                <select id="titleTemplate" class="form-select" onchange="updateTitlePreview()">
                                    <option value="">-- Select a Template or Enter Custom --</option>
                                    <optgroup label="Top X Format">
                                        <option value="Top {count} {type} in {destination} for {year}">Top {count} {type} in {destination} for {year}</option>
                                        <option value="{count} Best {type} in {destination} ({year} Guide)">{count} Best {type} in {destination} ({year} Guide)</option>
                                        <option value="The Ultimate Guide to {destination}: Top {count} {type}">The Ultimate Guide to {destination}: Top {count} {type}</option>
                                    </optgroup>
                                    <optgroup label="Sustainable Focus">
                                        <option value="{count} Most Sustainable {type} in {destination}">{count} Most Sustainable {type} in {destination}</option>
                                        <option value="Eco-Friendly Travel: {count} Green {type} in {destination}">Eco-Friendly Travel: {count} Green {type} in {destination}</option>
                                        <option value="{count} Sustainable {type} You Must Try in {destination}">{count} Sustainable {type} You Must Try in {destination}</option>
                                    </optgroup>
                                    <optgroup label="Hygge Focus">
                                        <option value="{count} Hygge-Inspired {type} in {destination}">{count} Hygge-Inspired {type} in {destination}</option>
                                        <option value="Experience Hygge: {count} Cozy {type} in {destination}">Experience Hygge: {count} Cozy {type} in {destination}</option>
                                    </optgroup>
                                    <optgroup label="Action-Oriented">
                                        <option value="{count} Amazing {type} You Can't Miss in {destination}">{count} Amazing {type} You Can't Miss in {destination}</option>
                                        <option value="Discover {destination}: {count} Must-Visit {type}">Discover {destination}: {count} Must-Visit {type}</option>
                                        <option value="Your {destination} Bucket List: {count} Essential {type}">Your {destination} Bucket List: {count} Essential {type}</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">Variables: {count}, {type}, {destination}, {year}</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Custom Title (Optional)</label>
                                <input type="text" name="custom_title" id="customTitle" class="form-control"
                                       placeholder="Leave blank to use template above" onchange="updateTitlePreview()">
                                <div id="titlePreview" class="mt-2 p-3 border rounded" style="background: #f8f9fa; display: none;">
                                    <strong>Preview:</strong> <span id="titlePreviewText"></span>
                                </div>
                            </div>

                            <!-- Step 3: Selection Method -->
                            <div class="col-12 mt-4">
                                <h5 class="fw-bold mb-3" style="color: var(--hygge-green);">
                                    <i class="fas fa-list-check me-2"></i>Step 3: Select Items
                                </h5>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Selection Method</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="selection_method" id="autoSelect" value="auto" checked onchange="toggleSelectionMethod()">
                                    <label class="btn btn-outline-primary" for="autoSelect">
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Auto-Select
                                    </label>

                                    <input type="radio" class="btn-check" name="selection_method" id="manualSelect" value="manual" onchange="toggleSelectionMethod()">
                                    <label class="btn btn-outline-success" for="manualSelect">
                                        <i class="fas fa-hand-pointer me-2"></i>Manual Selection
                                    </label>
                                </div>
                            </div>

                            <!-- Auto Selection Options -->
                            <div id="autoSelectionOptions" class="col-12">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Number of Items</label>
                                        <select name="item_count" class="form-select" required>
                                            <option value="5">Top 5</option>
                                            <option value="10" selected>Top 10</option>
                                            <option value="15">Top 15</option>
                                            <option value="20">Top 20</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Filter By</label>
                                        <select name="filter_by" id="filterBy" class="form-select">
                                            <option value="sustainability">Most Sustainable</option>
                                            <option value="hygge">Most Hygge</option>
                                            <option value="featured">Featured Only</option>
                                            <option value="recent">Most Recent</option>
                                            <option value="random">Random Selection</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Manual Selection Options -->
                            <div id="manualSelectionOptions" class="col-12" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>Select destination first, then check the items you want to include
                                </div>

                                <div id="manualItemsList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background: #f8f9fa;">
                                    <p class="text-muted text-center py-4">Please select a destination to see available items</p>
                                </div>
                            </div>

                            <!-- Additional Options -->
                            <div class="col-12 mt-4">
                                <h5 class="fw-bold mb-3" style="color: var(--hygge-green);">
                                    <i class="fas fa-sliders me-2"></i>Additional Options
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Publish Immediately</label>
                                <select name="publish" class="form-select">
                                    <option value="false" selected>Save as Draft</option>
                                    <option value="true">Publish Now</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Include Introduction</label>
                                <select id="includeIntro" class="form-select">
                                    <option value="auto" selected>Auto-Generate</option>
                                    <option value="custom">Custom Introduction</option>
                                    <option value="none">No Introduction</option>
                                </select>
                            </div>

                            <div id="customIntroSection" class="col-12" style="display: none;">
                                <label class="form-label fw-bold">Custom Introduction</label>
                                <textarea name="custom_intro" class="form-control" rows="3"
                                          placeholder="Write your custom introduction paragraph..."></textarea>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-hygge btn-lg">
                                    <i class="fas fa-magic me-2"></i>Generate Blog Post
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="previewBtn">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Preview Section (hidden by default) -->
                    <div id="previewSection" class="mt-4 pt-4 border-top" style="display: none;">
                        <h5 class="fw-bold mb-3">Preview</h5>
                        <div id="previewContent" class="border rounded p-4" style="background: var(--hygge-warm-white);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- SOCIAL MEDIA CONTENT GENERATOR -->
    <!-- ============================================== -->

    <style>
/* Social Media Generator Styles */
.bg-gradient-social {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#socialMediaGeneratorSection .form-label {
    color: #2d3748;
    font-size: 0.95rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#socialMediaGeneratorSection .form-control,
#socialMediaGeneratorSection .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.3s ease;
}

#socialMediaGeneratorSection .form-control:focus,
#socialMediaGeneratorSection .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
}

#generateSocialBtn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

#generateSocialBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

#socialMediaCarousel {
    background: #000;
    max-width: 600px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
}

#socialMediaCarousel .carousel-inner {
    border-radius: 16px;
}

#socialMediaCarousel .carousel-item img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 16px;
}

#socialMediaCarousel .carousel-indicators button {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    border: 2px solid #fff;
    transition: all 0.3s ease;
}

#socialMediaCarousel .carousel-indicators button.active {
    background-color: #fff;
    transform: scale(1.2);
}

#downloadSocialBtn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    border-radius: 12px;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    transition: all 0.3s ease;
}

#downloadSocialBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
}

#socialImageCounter {
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
}

@media (max-width: 768px) {
    #socialMediaCarousel {
        max-width: 100%;
    }

    #generateSocialBtn,
    #downloadSocialBtn {
        width: 100%;
        margin-bottom: 1rem;
    }
}

/* Experience Selection Styles */
#experienceCheckboxList .form-check {
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    transition: all 0.2s ease;
}

#experienceCheckboxList .form-check:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

#experienceCheckboxList .form-check-input {
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.15em;
}

#experienceCheckboxList .form-check-label {
    cursor: pointer;
    padding-left: 0.5rem;
    user-select: none;
}
</style>

<!-- Social Media Content Generator Section -->
<div class="row mb-5" id="socialMediaGeneratorSection">
    <div class="col-12">
        <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
            <i class="fas fa-images me-2"></i>Social Media Content Generator
        </h3>
        <p class="text-muted mb-4">Create a beautiful Instagram carousel with custom titles and hand-picked experiences. Choose a destination, select specific experiences, customize your cover title, and generate professional carousel images with a HygGeo.com promotional card.</p>
    </div>
</div>

<div class="row mb-5">
    <div class="col-12">
        <div class="card card-hygge shadow-lg" style="border: none;">
            <div class="card-header bg-gradient-social text-white py-4">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-magic me-2"></i>
                    Generate Instagram Carousel
                </h5>
            </div>

            <div class="card-body p-5">
                <!-- Generator Form -->
                <form id="socialMediaForm" class="needs-validation" novalidate>
                    <div class="row g-4">
                        <!-- Destination Selection -->
                        <div class="col-md-6">
                            <label for="socialDestinationSelect" class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Destination
                            </label>
                            <select id="socialDestinationSelect" class="form-select form-select-lg" required>
                                <option value="">Choose a destination...</option>
                                {% for dest in all_destinations %}
                                <option value="{{ dest.id }}" data-name="{{ dest.name }}" data-image="{% if dest.image %}{{ dest.image.url }}{% endif %}">{{ dest.name }}, {{ dest.country }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a destination.</div>
                            <small class="form-text text-muted">This will load all available experiences for you to choose from</small>
                        </div>

                        <!-- Template Selection -->
                        <div class="col-md-6">
                            <label for="socialTemplateSelect" class="form-label">
                                <i class="fas fa-file-alt me-2"></i>Cover Title Style
                            </label>
                            <select id="socialTemplateSelect" class="form-select form-select-lg" required>
                                <option value="">Choose a template...</option>
                                <option value="top-experiences">Top X in [Location] (e.g., "Top 5 in Paris")</option>
                                <option value="hidden-gems">[Location]: Hidden Gems (e.g., "Paris: Hidden Gems")</option>
                                <option value="must-visit">[Location] Must-Visits (e.g., "Paris Must-Visits")</option>
                                <option value="discover">Discover [Location] (e.g., "Discover Paris")</option>
                                <option value="explore">Explore [Location] (e.g., "Explore Paris")</option>
                                <option value="custom">Custom Template</option>
                            </select>
                            <div class="invalid-feedback">Please select a template.</div>
                            <small class="form-text text-muted">Choose a preset template or create your own custom title</small>
                        </div>

                        <!-- Custom Template Input -->
                        <div class="col-md-12" id="customTemplateContainer" style="display: none;">
                            <label for="customTemplateInput" class="form-label">
                                <i class="fas fa-edit me-2"></i>Custom Template Text
                            </label>
                            <input type="text" id="customTemplateInput" class="form-control form-control-lg"
                                   placeholder="Enter your custom title (e.g., 'Best of Paris', 'Paris Adventure Guide')">
                            <small class="form-text text-muted">Your custom text will appear on the cover image</small>
                        </div>

                        <!-- Text Style Selection -->
                        <div class="col-md-12">
                            <label for="socialTextStyleSelect" class="form-label">
                                <i class="fas fa-palette me-2"></i>Text Overlay Style
                            </label>
                            <select id="socialTextStyleSelect" class="form-select form-select-lg" required>
                                <option value="">Choose a visual style...</option>
                                <option value="modern-minimal">Modern Minimal - Clean & Professional</option>
                                <option value="bold-impact">Bold Impact - Eye-Catching Headlines</option>
                                <option value="elegant-serif">Elegant Serif - Luxury Feel</option>
                                <option value="vibrant-gradient">Vibrant Gradient - Colorful & Fun</option>
                                <option value="magazine-style">Magazine Style - Editorial Look</option>
                            </select>
                            <div class="invalid-feedback">Select a text style.</div>
                        </div>

                        <!-- Experience Selection -->
                        <div class="col-md-12" id="experienceSelectionContainer" style="display: none;">
                            <div class="border rounded p-4" style="background: #f8f9fa;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label mb-0">
                                        <i class="fas fa-list-check me-2"></i>Select Experiences
                                    </label>
                                    <div>
                                        <button type="button" id="selectAllExperiences" class="btn btn-sm btn-outline-primary me-2">
                                            Select All
                                        </button>
                                        <button type="button" id="clearAllExperiences" class="btn btn-sm btn-outline-secondary">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                                <small class="form-text text-muted d-block mb-3">
                                    <span id="selectedCount">0</span> experience(s) selected. Choose which experiences to include in your carousel.
                                </small>
                                <div id="experienceCheckboxList" class="row g-2">
                                    <!-- Checkboxes will be dynamically loaded here -->
                                </div>
                                <div id="experienceLoadingSpinner" class="text-center py-4 d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading experiences...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <div class="col-12 mt-5">
                            <button type="submit" id="generateSocialBtn" class="btn btn-primary btn-lg px-5 py-3 w-100">
                                <i class="fas fa-magic me-2"></i>
                                Generate Instagram Carousel
                            </button>
                            <div id="socialLoadingSpinner" class="spinner-border text-primary ms-3 d-none" role="status">
                                <span class="visually-hidden">Generating...</span>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Error Alert -->
                <div id="socialErrorAlert" class="alert alert-danger mt-4 d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="socialErrorMessage"></span>
                </div>

                <!-- Success Alert -->
                <div id="socialSuccessAlert" class="alert alert-success mt-4 d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="socialSuccessMessage"></span>
                </div>

                <!-- Preview Section -->
                <div id="socialPreviewSection" class="mt-5 d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>Preview Generated Content
                        </h5>
                        <button id="downloadSocialBtn" class="btn btn-success btn-lg">
                            <i class="fas fa-download me-2"></i>Download ZIP
                        </button>
                    </div>

                    <!-- Bootstrap Carousel -->
                    <div id="socialMediaCarousel" class="carousel slide shadow-lg rounded" data-bs-ride="false" data-bs-interval="false">
                        <div class="carousel-indicators" id="socialCarouselIndicators">
                            <!-- Indicators dynamically added -->
                        </div>
                        <div class="carousel-inner" id="socialCarouselInner">
                            <!-- Slides dynamically added -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#socialMediaCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#socialMediaCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>

                    <!-- Image Counter -->
                    <div class="text-center mt-3">
                        <span id="socialImageCounter" class="badge bg-secondary fs-6">
                            Image 1 of 5
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Canvas for Image Generation -->
<canvas id="socialGeneratorCanvas" width="1080" height="1080" style="display: none;"></canvas>

<script>
/**
 * Social Media Content Generator - Integrated with Real Experiences
 */
(function() {
    'use strict';

    // Configuration
    const CONFIG = {
        CANVAS_SIZE: 1080,
        IMAGE_FORMAT: 'image/png',
        IMAGE_QUALITY: 0.95,
        NUM_VARIANTS: 5,
        FONTS_LOADED: false,
        FALLBACK_IMAGE: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1080&h=1080&fit=crop' // Nature fallback
    };

    // Template definitions
    const TEMPLATES = {
        'top-experiences': 'Top {X} in {location}',
        'hidden-gems': '{location}: Hidden Gems',
        'must-visit': '{location} Must-Visits',
        'discover': 'Discover {location}',
        'explore': 'Explore {location}'
    };

    // Beautiful Text Overlay Styles
    const TEXT_STYLES = {
        'modern-minimal': {
            applyCoverStyle: (ctx, text, width, height) => {
                // Clean dark overlay at bottom
                const gradient = ctx.createLinearGradient(0, height - 350, 0, height);
                gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0.85)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, height - 350, width, 350);

                // Main title - dynamic sizing
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), width - 100, 90, 'Montserrat, sans-serif');
                ctx.font = `900 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#ffffff';

                // Wrap text if needed
                const maxWidth = width - 100;
                wrapText(ctx, text.toUpperCase(), width / 2, height - 140, maxWidth, fontSize + 10, 2);

                // Subtle underline
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(width / 2 - 100, height - 70, 200, 4);
            },
            applyExperienceStyle: (ctx, text, number, width, height) => {
                // Top gradient overlay
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 0, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, 300);

                // Number badge
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(40, 40, 100, 100);
                ctx.font = 'bold 60px Montserrat, sans-serif';
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText(number, 90, 105);

                // Experience title with smart sizing
                const maxWidth = width - 200;
                const fontSize = getOptimalFontSize(ctx, text, maxWidth, 55, 'Montserrat, sans-serif');
                ctx.font = `700 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 15;
                wrapText(ctx, text, 180, 100, maxWidth, fontSize + 10, 3);
            }
        },
        'bold-impact': {
            applyCoverStyle: (ctx, text, width, height) => {
                // Bold black box
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, height / 2 - 200, width, 400);

                // Yellow accent strips
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(0, height / 2 - 212, width, 12);
                ctx.fillRect(0, height / 2 + 188, width, 12);

                // Bold title with smart sizing
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), width - 140, 85, 'Montserrat, Impact, sans-serif');
                ctx.font = `900 ${fontSize}px Montserrat, Impact, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const maxWidth = width - 140;

                // Draw text with stroke effect
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 12;
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;

                const lines = wrapText(ctx, text.toUpperCase(), width / 2, height / 2, maxWidth, fontSize + 20, 2);

                // Re-draw with stroke
                ctx.textAlign = 'center';
                const startY = height / 2 - ((lines.length - 1) * (fontSize + 20) / 2);
                lines.forEach((line, i) => {
                    const y = startY + (i * (fontSize + 20));
                    ctx.strokeText(line.trim(), width / 2, y);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillText(line.trim(), width / 2, y);
                });
            },
            applyExperienceStyle: (ctx, text, number, width, height) => {
                // Bottom bold bar
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                ctx.fillRect(0, height - 270, width, 270);

                // Yellow accent line
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(0, height - 282, width, 12);

                // Number in yellow circle
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(95, height - 135, 65, 0, Math.PI * 2);
                ctx.fill();

                ctx.font = 'bold 70px Montserrat, sans-serif';
                ctx.fillStyle = '#000000';
                ctx.textAlign = 'center';
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.fillText(number, 95, height - 115);

                // Title with smart sizing
                const maxWidth = width - 240;
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), maxWidth, 52, 'Montserrat, sans-serif');
                ctx.font = `900 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(255, 215, 0, 0.3)';
                ctx.shadowBlur = 8;
                wrapText(ctx, text.toUpperCase(), 210, height - 165, maxWidth, fontSize + 12, 2);
            }
        },
        'elegant-serif': {
            applyCoverStyle: (ctx, text, width, height) => {
                // Elegant vignette
                const gradient = ctx.createRadialGradient(width / 2, height / 2, 200, width / 2, height / 2, 800);
                gradient.addColorStop(0, 'rgba(0, 0, 0, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0.75)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);

                // Gold frame
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 6;
               
                ctx.strokeRect(80, height / 2 - 150, width - 160, 300);
                
                // Serif title with smart sizing
                const fontSize = getOptimalFontSize(ctx, text, width - 200, 75, 'Georgia, Playfair Display, serif');
                ctx.font = `700 ${fontSize}px Georgia, Playfair Display, serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeStyle = '#D4AF37';
                ctx.fillStyle = '#ffffff';
                ctx.lineWidth = 2;
                const maxWidth = width - 200;
                const lines = wrapText(ctx, text, width / 2, height / 2, maxWidth, fontSize + 15, 2);

                // Re-stroke the text
                // lines.forEach((line, i) => {
                //     const y = height / 2 + (i * (fontSize + 15)) - ((lines.length - 1) * (fontSize + 15) / 2);
                //     ctx.strokeText(line.trim(), width / 2, y);
                // });

                // Decorative elements
                ctx.font = '40px Georgia, serif';
                ctx.fillStyle = '#D4AF37';
                ctx.fillText('✦', width / 2, height / 2 - 120);
                ctx.fillText('✦', width / 2, height / 2 + 120);
            },
            applyExperienceStyle: (ctx, text, number, width, height) => {
                // Elegant gradient overlay
                const gradient = ctx.createLinearGradient(0, height - 320, 0, height);
                gradient.addColorStop(0, 'rgba(20, 20, 20, 0)');
                gradient.addColorStop(1, 'rgba(20, 20, 20, 0.9)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, height - 320, width, 320);

                // Gold number
                ctx.font = '700 80px Georgia, serif';
                ctx.textAlign = 'left';
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 3;
                ctx.strokeText(number, 60, height - 200);
                ctx.fillStyle = '#FFFBEB';
                ctx.fillText(number, 60, height - 200);

                // Title with smart sizing
                const maxWidth = width - 120;
                const fontSize = getOptimalFontSize(ctx, text, maxWidth, 50, 'Georgia, serif');
                ctx.font = `600 ${fontSize}px Georgia, serif`;
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 1.5;
                const lines = wrapText(ctx, text, 60, height - 120, maxWidth, fontSize + 10, 3);
                lines.forEach((line, i) => {
                    ctx.strokeText(line, 60, height - 120 + (i * (fontSize + 10)));
                    ctx.fillText(line, 60, height - 120 + (i * (fontSize + 10)));
                });
            }
        },
        'vibrant-gradient': {
            applyCoverStyle: (ctx, text, width, height) => {
                // Dark background for contrast
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, width, height);

                // Title with vibrant gradient background box
                const boxHeight = 200;
                const gradient = ctx.createLinearGradient(0, height / 2 - boxHeight / 2, width, height / 2 + boxHeight / 2);
                gradient.addColorStop(0, '#FF6B6B');
                gradient.addColorStop(0.5, '#4ECDC4');
                gradient.addColorStop(1, '#45B7D1');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, height / 2 - boxHeight / 2, width, boxHeight);

                // Text with smart sizing
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), width - 120, 80, 'Montserrat, sans-serif');
                ctx.font = `900 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // White text with shadow
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 4;

                const maxWidth = width - 120;
                wrapText(ctx, text.toUpperCase(), width / 2, height / 2, maxWidth, fontSize + 15, 2);
            },
            applyExperienceStyle: (ctx, text, number, width, height) => {
                // Gradient bottom bar
                const gradient = ctx.createLinearGradient(0, height - 280, width, height);
                gradient.addColorStop(0, '#FF6B6B');
                gradient.addColorStop(0.5, '#4ECDC4');
                gradient.addColorStop(1, '#45B7D1');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, height - 280, width, 280);

                // White circle for number
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(90, height - 140, 60, 0, Math.PI * 2);
                ctx.fill();

                // Number in gradient color
                ctx.font = 'bold 70px Montserrat, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#FF6B6B';
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.fillText(number, 90, height - 120);

                // Title with smart sizing
                const maxWidth = width - 220;
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), maxWidth, 55, 'Montserrat, sans-serif');
                ctx.font = `800 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                ctx.shadowBlur = 10;
                wrapText(ctx, text.toUpperCase(), 200, height - 170, maxWidth, fontSize + 10, 2);
            }
        },
        'magazine-style': {
            applyCoverStyle: (ctx, text, width, height) => {
                // Subtle overlay
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, width, height);

                // Clean white box
                const boxPadding = 80;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.97)';
                ctx.fillRect(boxPadding, height / 2 - 220, width - (boxPadding * 2), 440);

                // Green accent line (hygge brand color)
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(boxPadding, height / 2 - 230, width - (boxPadding * 2), 8);

                // Title with smart sizing
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), width - 240, 70, 'Montserrat, sans-serif');
                ctx.font = `900 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#1a1a1a';

                const maxWidth = width - 240;
                wrapText(ctx, text.toUpperCase(), width / 2, height / 2 - 60, maxWidth, fontSize + 12, 2);

                // Subtitle
                ctx.font = '400 28px Montserrat, sans-serif';
                ctx.fillStyle = '#666666';
                ctx.textAlign = 'center';
                ctx.fillText('A SUSTAINABLE TRAVEL GUIDE', width / 2, height / 2 + 80);

                // Decorative line
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(width / 2 - 60, height / 2 + 20, 120, 2);
            },
            applyExperienceStyle: (ctx, text, number, width, height) => {
                // Clean white box at bottom
                ctx.fillStyle = 'rgba(255, 255, 255, 0.97)';
                ctx.fillRect(0, height - 280, width, 280);

                // Green accent top line
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(0, height - 290, width, 8);

                // Number in green box
                ctx.fillStyle = '#2d5a3d';
                ctx.fillRect(50, height - 230, 100, 100);
                ctx.font = 'bold 65px Montserrat, sans-serif';
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText(number, 100, height - 165);

                // Title in black with smart sizing
                const maxWidth = width - 220;
                const fontSize = getOptimalFontSize(ctx, text.toUpperCase(), maxWidth, 48, 'Montserrat, sans-serif');
                ctx.font = `800 ${fontSize}px Montserrat, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#1a1a1a';
                wrapText(ctx, text.toUpperCase(), 190, height - 215, maxWidth, fontSize + 10, 3);
            }
        }
    };

    // Helper function to wrap text with smart sizing
    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines = 3) {
        const words = text.split(' ');
        let line = '';
        const lines = [];

        for (let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = ctx.measureText(testLine);
            const testWidth = metrics.width;

            if (testWidth > maxWidth && n > 0) {
                lines.push(line);
                line = words[n] + ' ';
            } else {
                line = testLine;
            }
        }
        lines.push(line);

        // If too many lines, truncate and add ellipsis
        if (lines.length > maxLines) {
            lines.splice(maxLines);
            lines[maxLines - 1] = lines[maxLines - 1].trim() + '...';
        }

        // Draw the lines
        lines.forEach((line, i) => {
            ctx.fillText(line.trim(), x, y + (i * lineHeight));
        });

        return lines;
    }

    // Smart text sizing - reduces font size if text is too long
    function getOptimalFontSize(ctx, text, maxWidth, baseFontSize, fontFamily) {
        let fontSize = baseFontSize;
        ctx.font = `bold ${fontSize}px ${fontFamily}`;

        while (ctx.measureText(text).width > maxWidth && fontSize > 30) {
            fontSize -= 2;
            ctx.font = `bold ${fontSize}px ${fontFamily}`;
        }

        return fontSize;
    }

    // Promotional card style for HygGeo.com - Modern Design
    function applyPromoCardStyle(ctx, width, height) {
        // Modern gradient background overlay
        const gradient = ctx.createLinearGradient(0, 0, width, height);
        gradient.addColorStop(0, 'rgba(45, 90, 61, 0.95)');
        gradient.addColorStop(1, 'rgba(35, 70, 48, 0.95)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);

        // Top accent line - subtle
        ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
        ctx.fillRect(0, 0, width, 3);

        // Central content area
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Small eyebrow text
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.font = '400 32px Montserrat, sans-serif';
        ctx.letterSpacing = '0.15em';
        ctx.fillText('READY TO EXPLORE?', width / 2, height / 2 - 200);

        // Main headline - big and bold
        ctx.fillStyle = '#ffffff';
        ctx.font = '900 100px Montserrat, sans-serif';
        ctx.fillText('Find Your Next', width / 2, height / 2 - 50);
        ctx.fillText('Adventure', width / 2, height / 2 + 70);

        // Website URL in a clean button-like style
        const buttonWidth = 550;
        const buttonHeight = 110;
        const buttonX = (width - buttonWidth) / 2;
        const buttonY = height / 2 + 170;

        // Button background - white
        ctx.fillStyle = '#ffffff';
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 25;
        ctx.shadowOffsetY = 8;
        roundRect(ctx, buttonX, buttonY, buttonWidth, buttonHeight, 55);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.shadowOffsetY = 0;

        // Website text in button
        ctx.fillStyle = '#2d5a3d';
        ctx.font = 'bold 65px Montserrat, sans-serif';
        ctx.fillText('HygGeo.com', width / 2, buttonY + buttonHeight / 2);

        // Bottom tagline
        ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
        ctx.font = '400 30px Montserrat, sans-serif';
        ctx.fillText('Curated Travel Experiences & Destinations', width / 2, height - 120);

        // Minimal decorative element - small icon
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.font = '45px sans-serif';
        ctx.fillText('✦', width / 2, height / 2 - 270);
    }

    // Helper function to draw rounded rectangles
    function roundRect(ctx, x, y, width, height, radius, topOnly = false, bottomOnly = false) {
        ctx.beginPath();
        if (topOnly) {
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height);
            ctx.lineTo(x, y + height);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
        } else if (bottomOnly) {
            ctx.moveTo(x, y);
            ctx.lineTo(x + width, y);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y);
        } else {
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
        }
        ctx.closePath();
    }

    // State
    let generatedImages = [];
    let currentDestination = null;
    let currentExperiences = [];
    let currentTemplate = '';
    let availableExperiences = [];

    // DOM Elements
    const elements = {
        form: document.getElementById('socialMediaForm'),
        templateSelect: document.getElementById('socialTemplateSelect'),
        destinationSelect: document.getElementById('socialDestinationSelect'),
        numberExperiences: document.getElementById('socialNumberExperiences'),
        textStyleSelect: document.getElementById('socialTextStyleSelect'),
        customTemplateContainer: document.getElementById('customTemplateContainer'),
        customTemplateInput: document.getElementById('customTemplateInput'),
        experienceSelectionContainer: document.getElementById('experienceSelectionContainer'),
        experienceCheckboxList: document.getElementById('experienceCheckboxList'),
        experienceLoadingSpinner: document.getElementById('experienceLoadingSpinner'),
        selectAllBtn: document.getElementById('selectAllExperiences'),
        clearAllBtn: document.getElementById('clearAllExperiences'),
        selectedCount: document.getElementById('selectedCount'),
        generateBtn: document.getElementById('generateSocialBtn'),
        downloadBtn: document.getElementById('downloadSocialBtn'),
        loadingSpinner: document.getElementById('socialLoadingSpinner'),
        errorAlert: document.getElementById('socialErrorAlert'),
        errorMessage: document.getElementById('socialErrorMessage'),
        successAlert: document.getElementById('socialSuccessAlert'),
        successMessage: document.getElementById('socialSuccessMessage'),
        previewSection: document.getElementById('socialPreviewSection'),
        carouselInner: document.getElementById('socialCarouselInner'),
        carouselIndicators: document.getElementById('socialCarouselIndicators'),
        imageCounter: document.getElementById('socialImageCounter'),
        canvas: document.getElementById('socialGeneratorCanvas')
    };

    // Initialize
    function init() {
        loadFonts();
        attachEventListeners();
        console.log('Social Media Generator initialized');
    }

    // Load fonts
    function loadFonts() {
        if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(() => {
                CONFIG.FONTS_LOADED = true;
                console.log('Fonts loaded successfully');
            });
        } else {
            setTimeout(() => { CONFIG.FONTS_LOADED = true; }, 1000);
        }
    }

    // Event listeners
    function attachEventListeners() {
        elements.form.addEventListener('submit', handleGenerate);
        elements.downloadBtn.addEventListener('click', handleDownload);
        elements.templateSelect.addEventListener('change', handleTemplateChange);
        elements.destinationSelect.addEventListener('change', handleDestinationChange);
        elements.selectAllBtn.addEventListener('click', selectAllExperiences);
        elements.clearAllBtn.addEventListener('click', clearAllExperiences);

        const carousel = document.getElementById('socialMediaCarousel');
        if (carousel) {
            carousel.addEventListener('slide.bs.carousel', (e) => {
                const index = e.to + 1;
                elements.imageCounter.textContent = `Image ${index} of ${generatedImages.length}`;
            });
        }
    }

    // Handle template selection change
    function handleTemplateChange() {
        const isCustom = elements.templateSelect.value === 'custom';
        elements.customTemplateContainer.style.display = isCustom ? 'block' : 'none';
        if (isCustom) {
            elements.customTemplateInput.focus();
        }
    }

    // Handle destination change - load experiences
    async function handleDestinationChange() {
        const destinationId = elements.destinationSelect.value;

        if (!destinationId) {
            elements.experienceSelectionContainer.style.display = 'none';
            availableExperiences = [];
            return;
        }

        try {
            elements.experienceLoadingSpinner.classList.remove('d-none');
            elements.experienceCheckboxList.innerHTML = '';

            const response = await fetch(`/accounts/admin/get-items-for-destination/?destination=${destinationId}&type=experiences`);
            const data = await response.json();

            availableExperiences = data.items || [];

            if (availableExperiences.length === 0) {
                elements.experienceCheckboxList.innerHTML = '<div class="col-12 text-muted text-center">No experiences found for this destination.</div>';
            } else {
                renderExperienceCheckboxes();
                elements.experienceSelectionContainer.style.display = 'block';
            }

        } catch (error) {
            console.error('Error loading experiences:', error);
            elements.experienceCheckboxList.innerHTML = '<div class="col-12 text-danger text-center">Error loading experiences.</div>';
        } finally {
            elements.experienceLoadingSpinner.classList.add('d-none');
        }
    }

    // Render experience checkboxes
    function renderExperienceCheckboxes() {
        elements.experienceCheckboxList.innerHTML = '';

        availableExperiences.forEach((exp, index) => {
            const col = document.createElement('div');
            col.className = 'col-md-6';

            const checkbox = document.createElement('div');
            checkbox.className = 'form-check';
            checkbox.innerHTML = `
                <input class="form-check-input experience-checkbox" type="checkbox" value="${exp.id}" id="exp_${exp.id}" data-index="${index}">
                <label class="form-check-label" for="exp_${exp.id}">
                    ${exp.name}
                </label>
            `;

            col.appendChild(checkbox);
            elements.experienceCheckboxList.appendChild(col);
        });

        // Add change event to all checkboxes
        document.querySelectorAll('.experience-checkbox').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        updateSelectedCount();
    }

    // Select all experiences
    function selectAllExperiences() {
        document.querySelectorAll('.experience-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateSelectedCount();
    }

    // Clear all experiences
    function clearAllExperiences() {
        document.querySelectorAll('.experience-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateSelectedCount();
    }

    // Update selected count
    function updateSelectedCount() {
        const count = document.querySelectorAll('.experience-checkbox:checked').length;
        elements.selectedCount.textContent = count;
    }

    // Handle generate
    async function handleGenerate(e) {
        e.preventDefault();

        if (!elements.form.checkValidity()) {
            e.stopPropagation();
            elements.form.classList.add('was-validated');
            return;
        }

        hideAlerts();

        // Get selected experiences
        const selectedCheckboxes = document.querySelectorAll('.experience-checkbox:checked');

        // Validate that at least one experience is selected
        if (selectedCheckboxes.length === 0) {
            showError('Please select at least one experience to include in the carousel.');
            return;
        }

        showLoading(true);

        try {
            const templateKey = elements.templateSelect.value;
            const destinationSelect = elements.destinationSelect;
            const destinationId = destinationSelect.value;
            const location = destinationSelect.options[destinationSelect.selectedIndex].dataset.name;
            const destinationImage = destinationSelect.options[destinationSelect.selectedIndex].dataset.image;
            const textStyle = elements.textStyleSelect.value;

            // Store destination info
            currentDestination = {
                id: destinationId,
                name: location,
                image: destinationImage || CONFIG.FALLBACK_IMAGE
            };

            // Get selected experiences from checkboxes
            currentExperiences = [];
            selectedCheckboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (availableExperiences[index]) {
                    currentExperiences.push(availableExperiences[index]);
                }
            });

            if (currentExperiences.length === 0) {
                throw new Error('No experiences selected.');
            }

            // Create the template text
            if (templateKey === 'custom') {
                // Use custom template
                currentTemplate = elements.customTemplateInput.value.trim();
                if (!currentTemplate) {
                    throw new Error('Please enter a custom template text.');
                }
            } else {
                // Use predefined template with replacements
                currentTemplate = TEMPLATES[templateKey]
                    .replace('{X}', currentExperiences.length)
                    .replace('{location}', location);
            }

            // Generate all images (1 cover + 1 per experience + 1 promo card)
            await generateCarousel(currentDestination, currentExperiences, currentTemplate, textStyle);
            displayPreview();

            showSuccess(`Successfully generated ${generatedImages.length} images (1 cover + ${currentExperiences.length} experiences + 1 HygGeo promo card)!`);

        } catch (error) {
            console.error('Generation error:', error);
            showError(error.message || 'Failed to generate images. Please try again.');
        } finally {
            showLoading(false);
        }
    }

    // Generate carousel images
    async function generateCarousel(destination, experiences, templateText, styleKey) {
        generatedImages = [];
        const ctx = elements.canvas.getContext('2d');
        const style = TEXT_STYLES[styleKey];

        if (!CONFIG.FONTS_LOADED) {
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // Image 1: Cover image with destination + title
        console.log('Generating cover image...');
        const coverImage = await loadImage(destination.image);
        ctx.clearRect(0, 0, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

        // Draw destination background
        drawBackgroundFitCover(ctx, coverImage);

        // Apply cover text style
        style.applyCoverStyle(ctx, templateText, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

        const coverDataUrl = elements.canvas.toDataURL(CONFIG.IMAGE_FORMAT, CONFIG.IMAGE_QUALITY);
        generatedImages.push({
            dataUrl: coverDataUrl,
            filename: `00_cover_${destination.name.replace(/\s+/g, '_')}.png`
        });

        // Images 2-N: One for each experience
        for (let i = 0; i < experiences.length; i++) {
            const exp = experiences[i];
            console.log(`Generating image ${i + 2} for: ${exp.name}`);

            const expImage = await loadImage(exp.image || CONFIG.FALLBACK_IMAGE);
            ctx.clearRect(0, 0, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

            // Draw experience background
            drawBackgroundFitCover(ctx, expImage);

            // Apply experience text style
            style.applyExperienceStyle(ctx, exp.name, (i + 1).toString(), CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

            const expDataUrl = elements.canvas.toDataURL(CONFIG.IMAGE_FORMAT, CONFIG.IMAGE_QUALITY);
            generatedImages.push({
                dataUrl: expDataUrl,
                filename: `${String(i + 1).padStart(2, '0')}_${exp.name.replace(/\s+/g, '_')}.png`
            });
        }

        // Final card: HygGeo.com promotional card
        console.log('Generating HygGeo.com promotional card...');
        const promoImage = await loadImage(destination.image);
        ctx.clearRect(0, 0, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

        // Draw destination background with darker overlay
        drawBackgroundFitCover(ctx, promoImage);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
        ctx.fillRect(0, 0, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

        // Apply promotional card style
        applyPromoCardStyle(ctx, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);

        const promoDataUrl = elements.canvas.toDataURL(CONFIG.IMAGE_FORMAT, CONFIG.IMAGE_QUALITY);
        generatedImages.push({
            dataUrl: promoDataUrl,
            filename: `${String(experiences.length + 1).padStart(2, '0')}_visit_hyggeo.png`
        });
    }

    // Draw background image with cover fit (fills canvas, maintains aspect ratio)
    function drawBackgroundFitCover(ctx, image) {
        const size = CONFIG.CANVAS_SIZE;
        const scale = Math.max(size / image.width, size / image.height);
        const scaledWidth = image.width * scale;
        const scaledHeight = image.height * scale;
        const x = (size - scaledWidth) / 2;
        const y = (size - scaledHeight) / 2;
        ctx.drawImage(image, x, y, scaledWidth, scaledHeight);
    }

    // Display preview
    function displayPreview() {
        elements.carouselInner.innerHTML = '';
        elements.carouselIndicators.innerHTML = '';

        generatedImages.forEach((img, index) => {
            const item = document.createElement('div');
            item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
            const imgElement = document.createElement('img');
            imgElement.src = img.dataUrl;
            imgElement.alt = `Generated image variant ${index + 1}`;
            imgElement.className = 'd-block w-100';
            item.appendChild(imgElement);
            elements.carouselInner.appendChild(item);

            const indicator = document.createElement('button');
            indicator.type = 'button';
            indicator.setAttribute('data-bs-target', '#socialMediaCarousel');
            indicator.setAttribute('data-bs-slide-to', index);
            if (index === 0) indicator.className = 'active';
            elements.carouselIndicators.appendChild(indicator);
        });

        elements.imageCounter.textContent = `Image 1 of ${generatedImages.length}`;
        elements.previewSection.classList.remove('d-none');
        elements.previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Handle download
    async function handleDownload() {
        if (generatedImages.length === 0) {
            showError('No images to download.');
            return;
        }

        showLoading(true);

        try {
            const zip = new JSZip();
            const folder = zip.folder('social_media_content');

            generatedImages.forEach(img => {
                const base64 = img.dataUrl.split(',')[1];
                folder.file(img.filename, base64, { base64: true });
            });

            const blob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `instagram_carousel_${currentDestination.name.replace(/\s+/g, '_')}_${Date.now()}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSuccess(`ZIP file downloaded successfully! ${generatedImages.length} images ready to post.`);

        } catch (error) {
            console.error('Download error:', error);
            showError('Failed to create ZIP file.');
        } finally {
            showLoading(false);
        }
    }

    // Utility functions
    function loadImage(url) {
        return new Promise((resolve, reject) => {
            // If no URL, use fallback
            if (!url || url === '') {
                console.warn('No image URL provided, using fallback');
                url = CONFIG.FALLBACK_IMAGE;
            }

            const img = new Image();

            // Use proxy for external images to avoid CORS issues
            let imageUrl = url;
            if (url.startsWith('http://') || url.startsWith('https://')) {
                // Use our proxy endpoint
                imageUrl = `/accounts/proxy-image/?url=${encodeURIComponent(url)}`;
                console.log(`Using proxy for: ${url}`);
            }

            img.onload = () => {
                console.log(`Successfully loaded image: ${url}`);
                resolve(img);
            };

            img.onerror = () => {
                console.warn(`Failed to load image: ${url}, using fallback`);

                // Use fallback image through proxy
                const fallbackImg = new Image();
                const fallbackUrl = `/accounts/proxy-image/?url=${encodeURIComponent(CONFIG.FALLBACK_IMAGE)}`;

                fallbackImg.onload = () => {
                    console.log('Loaded fallback image');
                    resolve(fallbackImg);
                };

                fallbackImg.onerror = () => {
                    console.error('Failed to load fallback image');
                    reject(new Error(`Failed to load fallback image`));
                };

                fallbackImg.src = fallbackUrl;
            };

            // Set src (no need for crossOrigin since we're using proxy from same domain)
            img.src = imageUrl;
        });
    }

    function showLoading(show) {
        elements.loadingSpinner.classList.toggle('d-none', !show);
        elements.generateBtn.disabled = show;
        elements.downloadBtn.disabled = show;
    }

    function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorAlert.classList.remove('d-none');
        elements.errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showSuccess(message) {
        elements.successMessage.textContent = message;
        elements.successAlert.classList.remove('d-none');
    }

    function hideAlerts() {
        elements.errorAlert.classList.add('d-none');
        elements.successAlert.classList.add('d-none');
    }

    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();
</script>

    <!-- Quick Tips -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="fw-bold"><i class="fas fa-lightbulb me-2"></i>Tips for Great Top 10 Posts:</h6>
                <ul class="mb-0 small">
                    <li>Use specific destinations for better targeting (e.g., "Copenhagen" not "Denmark")</li>
                    <li>Filter by sustainability or hygge factor to align with your brand</li>
                    <li>Each item will automatically include its booking link</li>
                    <li>Add SEO meta title and description after generation for better search visibility</li>
                    <li>Generated posts are saved to your drafts - review and customize before publishing</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Management Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-list me-2"></i>Manage Existing Content
            </h3>
        </div>
    </div>

    <!-- Management Cards -->
    <div class="row mb-5">
        <!-- View All Experiences -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-eye mb-2" style="font-size: 2rem; color: var(--hygge-green);"></i>
                    <h6 class="fw-bold mb-2 small">View Experiences</h6>
                    <a href="{% url 'experiences:experience_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-arrow-right me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Experiences -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-edit mb-2" style="font-size: 2rem; color: var(--hygge-gold);"></i>
                    <h6 class="fw-bold mb-2 small">Edit Experiences</h6>
                    <a href="{% url 'experiences:experience_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-arrow-right me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <!-- View All Destinations -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-globe mb-2" style="font-size: 2rem; color: var(--hygge-soft-blue);"></i>
                    <h6 class="fw-bold mb-2 small">View Destinations</h6>
                    <a href="{% url 'experiences:destination_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-arrow-right me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Destinations -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-map-marker-alt mb-2" style="font-size: 2rem; color: var(--hygge-gold);"></i>
                    <h6 class="fw-bold mb-2 small">Edit Destinations</h6>
                    <a href="{% url 'experiences:destination_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-edit me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="col-lg-6 col-xl-3 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-users-cog mb-2" style="font-size: 2rem; color: var(--hygge-gold);"></i>
                    <h6 class="fw-bold mb-2 small">User Management</h6>
                    <a href="{% url 'user_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-arrow-right me-1"></i>Manage Users
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Categories -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-tags mb-2" style="font-size: 2rem; color: var(--hygge-light-green);"></i>
                    <h6 class="fw-bold mb-2 small">Edit Categories</h6>
                    <a href="{% url 'experiences:category_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-edit me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Experience Types -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-list-ul mb-2" style="font-size: 2rem; color: #e74c3c;"></i>
                    <h6 class="fw-bold mb-2 small">Edit Types</h6>
                    <a href="{% url 'experiences:experience_type_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-edit me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <!-- View All Accommodations -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-bed mb-2" style="font-size: 2rem; color: #9b59b6;"></i>
                    <h6 class="fw-bold mb-2 small">View Accommodations</h6>
                    <a href="{% url 'experiences:accommodation_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-arrow-right me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Accommodations -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-hotel mb-2" style="font-size: 2rem; color: #9b59b6;"></i>
                    <h6 class="fw-bold mb-2 small">Edit Accommodations</h6>
                    <a href="{% url 'experiences:accommodation_list' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-edit me-1"></i>Manage
                    </a>
                </div>
            </div>
        </div>

        <!-- Analytics -->
        <div class="col-lg-6 col-xl-2 mb-4">
            <div class="card card-hygge h-100">
                <div class="card-body text-center p-3">
                    <i class="fas fa-chart-bar mb-2" style="font-size: 2rem; color: var(--hygge-light-green);"></i>
                    <h6 class="fw-bold mb-2 small">Analytics</h6>
                    <a href="{% url 'analytics_dashboard' %}" class="btn btn-sm btn-outline-hygge">
                        <i class="fas fa-chart-line me-1"></i>View Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Section -->
    {% if recent_experiences %}
    <div class="row">
        <div class="col-12">
            <h3 class="fw-bold mb-4" style="color: var(--hygge-green);">
                <i class="fas fa-clock me-2"></i>Recent Activity
            </h3>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-hygge">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Recently Added Experiences</h5>
                    <div class="row">
                        {% for experience in recent_experiences %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="border rounded p-3 h-100" style="background: var(--hygge-warm-white);">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-0">{{ experience.title }}</h6>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'experiences:experience_detail' experience.slug %}">
                                                <i class="fas fa-eye me-2"></i>View
                                            </a></li>
                                            <li><a class="dropdown-item" href="{% url 'experiences:edit_experience' experience.slug %}">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ experience.destination.name }}
                                </p>
                                <div class="d-flex justify-content-between align-items-center small text-muted">
                                    <span><i class="fas fa-calendar me-1"></i>{{ experience.created_at|date:"M d, Y" }}</span>
                                    {% if experience.is_featured %}
                                    <span class="badge bg-warning">Featured</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Links Footer -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="text-center py-4">
                <p class="text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Need help? Check the <a href="#" class="text-decoration-none">Admin Documentation</a> or 
                    <a href="mailto:admin@hyggeo.com" class="text-decoration-none">contact support</a>.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .admin-action-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .admin-action-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .action-icon {
        transition: transform 0.3s ease;
    }
    
    .admin-action-card:hover .action-icon {
        transform: scale(1.1);
    }
    
    .card-hygge .btn {
        transition: all 0.3s ease;
    }
    
    .stats-card {
        background: linear-gradient(135deg, var(--hygge-cream), var(--hygge-warm-white));
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Toggle featured status via AJAX
    document.querySelectorAll('.toggle-featured-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const button = this;
            const contentId = button.dataset.id;
            const contentType = button.dataset.type;
            const isFeatured = button.dataset.featured === 'true';

            // Disable button during request
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Send AJAX request
            fetch('{% url "toggle_featured_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `content_type=${contentType}&content_id=${contentId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state
                    button.dataset.featured = data.is_featured;
                    const row = button.closest('tr');
                    if (row) {
                        row.dataset.featured = data.is_featured;
                    }

                    if (data.is_featured) {
                        button.classList.remove('btn-outline-secondary');
                        button.classList.add('btn-warning');
                        button.title = 'Remove from featured';
                    } else {
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-outline-secondary');
                        button.title = 'Add to featured';
                    }
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.disabled = false;

                    // Update badge counts
                    updateBadgeCounts();

                    // Refresh filters to show/hide based on current filter setting
                    if (contentType === 'experience' && typeof filterExperiences === 'function') {
                        filterExperiences();
                    } else if (contentType === 'accommodation' && typeof filterAccommodations === 'function') {
                        filterAccommodations();
                    }

                    // Show success message
                    showToast(data.message, 'success');
                } else {
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.disabled = false;
                    showToast('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                button.innerHTML = '<i class="fas fa-star"></i>';
                button.disabled = false;
                showToast('Network error occurred', 'error');
            });
        });
    });

    // Update badge counts
    function updateBadgeCounts() {
        const expFeaturedCount = document.querySelectorAll('#experiencesTableBody .toggle-featured-btn[data-featured="true"]').length;
        const expTotalCount = document.querySelectorAll('#experiencesTableBody .toggle-featured-btn').length;
        const accFeaturedCount = document.querySelectorAll('#accommodationsTableBody .toggle-featured-btn[data-featured="true"]').length;
        const accTotalCount = document.querySelectorAll('#accommodationsTableBody .toggle-featured-btn').length;

        const expBadge = document.querySelector('#experiences-tab .badge');
        const accBadge = document.querySelector('#accommodations-tab .badge');

        if (expBadge) expBadge.textContent = `${expFeaturedCount}/${expTotalCount}`;
        if (accBadge) accBadge.textContent = `${accFeaturedCount}/${accTotalCount}`;
    }

    // Simple toast notification
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // Filter and search functionality for experiences
    function filterExperiences() {
        const searchTerm = document.getElementById('experienceSearch').value.toLowerCase();
        const filterValue = document.getElementById('experienceFilter').value;
        const rows = document.querySelectorAll('#experiencesTableBody tr[data-searchable]');
        let visibleCount = 0;

        rows.forEach(row => {
            const searchableText = row.dataset.searchable;
            const isFeatured = row.dataset.featured === 'true';
            const isActive = row.dataset.active === 'true';

            // Apply search filter
            const matchesSearch = searchableText.includes(searchTerm);

            // Apply status filter
            let matchesFilter = true;
            switch(filterValue) {
                case 'featured':
                    matchesFilter = isFeatured;
                    break;
                case 'not-featured':
                    matchesFilter = !isFeatured;
                    break;
                case 'active':
                    matchesFilter = isActive;
                    break;
                case 'inactive':
                    matchesFilter = !isActive;
                    break;
                case 'all':
                    matchesFilter = true;
                    break;
            }

            // Show/hide row based on both filters
            if (matchesSearch && matchesFilter) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update count display
        document.getElementById('experienceCountText').textContent = visibleCount;
        updateBadgeCounts();
    }

    const experienceSearch = document.getElementById('experienceSearch');
    const experienceFilter = document.getElementById('experienceFilter');
    if (experienceSearch) {
        experienceSearch.addEventListener('input', filterExperiences);
    }
    if (experienceFilter) {
        experienceFilter.addEventListener('change', filterExperiences);
        // Initialize count on page load
        setTimeout(filterExperiences, 100);
    }

    // Filter and search functionality for accommodations
    function filterAccommodations() {
        const searchTerm = document.getElementById('accommodationSearch').value.toLowerCase();
        const filterValue = document.getElementById('accommodationFilter').value;
        const rows = document.querySelectorAll('#accommodationsTableBody tr[data-searchable]');
        let visibleCount = 0;

        rows.forEach(row => {
            const searchableText = row.dataset.searchable;
            const isFeatured = row.dataset.featured === 'true';
            const isActive = row.dataset.active === 'true';

            // Apply search filter
            const matchesSearch = searchableText.includes(searchTerm);

            // Apply status filter
            let matchesFilter = true;
            switch(filterValue) {
                case 'featured':
                    matchesFilter = isFeatured;
                    break;
                case 'not-featured':
                    matchesFilter = !isFeatured;
                    break;
                case 'active':
                    matchesFilter = isActive;
                    break;
                case 'inactive':
                    matchesFilter = !isActive;
                    break;
                case 'all':
                    matchesFilter = true;
                    break;
            }

            // Show/hide row based on both filters
            if (matchesSearch && matchesFilter) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update count display
        document.getElementById('accommodationCountText').textContent = visibleCount;
        updateBadgeCounts();
    }

    const accommodationSearch = document.getElementById('accommodationSearch');
    const accommodationFilter = document.getElementById('accommodationFilter');
    if (accommodationSearch) {
        accommodationSearch.addEventListener('input', filterAccommodations);
    }
    if (accommodationFilter) {
        accommodationFilter.addEventListener('change', filterAccommodations);
        // Initialize count on page load
        setTimeout(filterAccommodations, 100);
    }

    // Add click handlers to make entire cards clickable
    document.querySelectorAll('.admin-action-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                const link = this.querySelector('a');
                if (link) {
                    link.click();
                }
            }
        });
    });

    // Add loading states to buttons (but not toggle buttons)
    document.querySelectorAll('.btn:not(.toggle-featured-btn)').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.href) {
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
            }
        });
    });

    // Blog Generator Functions
    window.updateTitlePreview = function() {
        const template = document.getElementById('titleTemplate').value;
        const customTitle = document.getElementById('customTitle').value;
        const destination = document.getElementById('destinationSelect').selectedOptions[0]?.text || '{destination}';
        const blogType = document.getElementById('blogType').value;
        const itemCount = document.querySelector('select[name="item_count"]').value || '10';
        const preview = document.getElementById('titlePreview');
        const previewText = document.getElementById('titlePreviewText');

        if (customTitle) {
            previewText.textContent = customTitle;
            preview.style.display = 'block';
        } else if (template) {
            const year = new Date().getFullYear();
            const typeMap = {
                'experiences': 'Experiences',
                'accommodations': 'Accommodations',
                'mixed': 'Things to Do'
            };
            const type = typeMap[blogType];

            const title = template
                .replace(/{count}/g, itemCount)
                .replace(/{type}/g, type)
                .replace(/{destination}/g, destination.split(',')[0])
                .replace(/{year}/g, year);

            previewText.textContent = title;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    };

    window.toggleSelectionMethod = function() {
        const autoOptions = document.getElementById('autoSelectionOptions');
        const manualOptions = document.getElementById('manualSelectionOptions');
        const autoRadio = document.getElementById('autoSelect');

        if (autoRadio.checked) {
            autoOptions.style.display = 'block';
            manualOptions.style.display = 'none';
        } else {
            autoOptions.style.display = 'none';
            manualOptions.style.display = 'block';
            loadItemsForDestination();
        }
    };

    window.loadItemsForDestination = function() {
        const destinationId = document.getElementById('destinationSelect').value;
        const blogType = document.getElementById('blogType').value;
        const manualSelect = document.getElementById('manualSelect');

        if (!manualSelect.checked || !destinationId) {
            return;
        }

        const itemsList = document.getElementById('manualItemsList');
        itemsList.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading items...</div>';

        // Fetch items via AJAX
        fetch(`/accounts/admin/get-items-for-destination/?destination=${destinationId}&type=${blogType}`)
            .then(response => response.json())
            .then(data => {
                if (data.items && data.items.length > 0) {
                    let html = '<div class="form-check-list">';
                    data.items.forEach(item => {
                        const statusBadge = item.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">Inactive</span>';
                        html += `
                            <div class="form-check p-3 mb-2 border rounded" style="background: white;">
                                <input class="form-check-input" type="checkbox" name="selected_items" value="${item.id}" id="item-${item.id}">
                                <label class="form-check-label w-100" for="item-${item.id}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>${item.name}</strong> ${statusBadge}
                                            <p class="small text-muted mb-1">${item.description}</p>
                                            <span class="badge bg-success">Sustainability: ${item.sustainability}/10</span>
                                            <span class="badge bg-info">Hygge: ${item.hygge}/10</span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `;
                    });
                    html += '</div>';
                    itemsList.innerHTML = html;
                } else {
                    itemsList.innerHTML = '<p class="text-muted text-center py-4">No items found for this destination</p>';
                }
            })
            .catch(error => {
                itemsList.innerHTML = '<p class="text-danger text-center py-4">Error loading items. Please try again.</p>';
                console.error('Error:', error);
            });
    };

    window.updateItemSelection = function() {
        // Clear manual selection when blog type changes
        const manualItemsList = document.getElementById('manualItemsList');
        manualItemsList.innerHTML = '<p class="text-muted text-center py-4">Please select a destination to see available items</p>';

        // Update title preview
        updateTitlePreview();
    };

    // Show/hide custom intro section
    document.getElementById('includeIntro').addEventListener('change', function() {
        const customIntroSection = document.getElementById('customIntroSection');
        if (this.value === 'custom') {
            customIntroSection.style.display = 'block';
        } else {
            customIntroSection.style.display = 'none';
        }
    });

    // Update title preview when count changes
    document.querySelector('select[name="item_count"]').addEventListener('change', updateTitlePreview);
});

// Generate Business Report with GSC Data
function generateReportWithGSCData() {
    const form = document.getElementById('gscDataForm');
    const formData = new FormData(form);

    // Build URL with query parameters
    const params = new URLSearchParams();

    // Add all form fields as query parameters
    for (let [key, value] of formData.entries()) {
        if (value) {  // Only add non-empty values
            params.append(key, value);
        }
    }

    // Generate the URL
    const baseUrl = '{% url "export_business_report_pdf" %}';
    const fullUrl = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('gscDataModal'));
    modal.hide();

    // Show loading message
    const toast = document.createElement('div');
    toast.className = 'alert alert-info position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Generating your business report... This may take a moment.
    `;
    document.body.appendChild(toast);

    // Navigate to download URL
    window.location.href = fullUrl;

    // Remove toast after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}

{% block extra_js %}
<!-- JSZip Library for Social Media Generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
// Add any additional JavaScript for the admin dashboard here
console.log('HygGeo Admin Dashboard loaded successfully');
</script>
{% endblock %}