{% extends 'base.html' %}
{% load static %}

{% block title %}Task Dashboard - HygGeo{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'task_management/css/task_management.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px; padding: var(--spacing-xl) 24px;">
    <!-- Hero Section -->
    <div class="modern-hero">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-tasks"></i> Task Dashboard
            </h1>
            <p class="hero-subtitle">
                Welcome back, <strong>{{ user.username }}</strong>! You have {{ pending_tasks }} task{{ pending_tasks|pluralize }} pending.
            </p>
            <div class="hero-actions">
                <a href="{% url 'task_management:task_create' %}" class="btn-hero">
                    <i class="fas fa-plus"></i>
                    New Task
                </a>
                {% if user.is_staff %}
                <a href="{% url 'task_management:project_create' %}" class="btn-hero btn-hero-outline">
                    <i class="fas fa-folder-plus"></i>
                    New Project
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card-modern blue">
            <div class="stat-icon blue">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-number">{{ total_tasks }}</div>
            <div class="stat-label">Total Tasks</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i> Active
            </div>
        </div>

        <div class="stat-card-modern purple">
            <div class="stat-icon purple">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="stat-number">{{ pending_tasks }}</div>
            <div class="stat-label">In Progress</div>
            <div class="stat-change positive">
                <i class="fas fa-spinner"></i> Working
            </div>
        </div>

        <div class="stat-card-modern green">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number">{{ completed_tasks }}</div>
            <div class="stat-label">Completed</div>
            <div class="stat-change positive">
                <i class="fas fa-check"></i> Done
            </div>
        </div>

        <div class="stat-card-modern red">
            <div class="stat-icon red">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-number">{{ overdue_tasks }}</div>
            <div class="stat-label">Overdue</div>
            {% if overdue_tasks > 0 %}
            <div class="stat-change negative">
                <i class="fas fa-exclamation"></i> Needs attention
            </div>
            {% else %}
            <div class="stat-change positive">
                <i class="fas fa-check"></i> All clear!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-modern">
        <a href="{% url 'task_management:dashboard' %}" class="nav-link active">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="{% url 'task_management:task_list' %}" class="nav-link">
            <i class="fas fa-list"></i> All Tasks
        </a>
        <a href="{% url 'task_management:kanban' %}" class="nav-link">
            <i class="fas fa-columns"></i> Kanban
        </a>
        <a href="{% url 'task_management:calendar' %}" class="nav-link">
            <i class="fas fa-calendar"></i> Calendar
        </a>
        <a href="{% url 'task_management:project_list' %}" class="nav-link">
            <i class="fas fa-folder"></i> Projects
        </a>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <div class="content-card-modern">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="fas fa-chart-pie"></i>
                    Task Distribution
                </h3>
            </div>
            <canvas id="statusChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="content-card-modern">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="fas fa-chart-bar"></i>
                    Priority Breakdown
                </h3>
            </div>
            <canvas id="priorityChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Recent Tasks & Upcoming -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="content-card-modern">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-clock"></i>
                        Recent Tasks
                    </h3>
                    <a href="{% url 'task_management:task_list' %}" class="btn-hero" style="padding: 10px 20px; font-size: 13px;">
                        View All
                    </a>
                </div>

                {% if recent_tasks %}
                    {% for task in recent_tasks %}
                    <div class="task-item-modern" onclick="window.location.href='{% url 'task_management:task_detail' task.pk %}'">
                        <input type="checkbox" class="task-checkbox" {% if task.status == 'completed' %}checked{% endif %} onclick="event.stopPropagation();">
                        <div class="task-content-modern">
                            <div class="task-title-modern">{{ task.title }}</div>
                            <div class="task-meta-modern">
                                <span><i class="fas fa-folder"></i> {% if task.project %}{{ task.project.name }}{% else %}No Project{% endif %}</span>
                                {% if task.due_date %}
                                <span><i class="fas fa-calendar"></i> {{ task.due_date|date:"M d" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="task-badges-modern">
                            <span class="badge-modern badge-priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state-modern">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="empty-title">No tasks yet</div>
                    <div class="empty-text">Create your first task to get started</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="content-card-modern">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-calendar-alt"></i>
                        Upcoming Deadlines
                    </h3>
                </div>

                {% if upcoming_deadlines %}
                    {% for task in upcoming_deadlines %}
                    <div class="task-item-modern" onclick="window.location.href='{% url 'task_management:task_detail' task.pk %}'">
                        <input type="checkbox" class="task-checkbox" {% if task.status == 'completed' %}checked{% endif %} onclick="event.stopPropagation();">
                        <div class="task-content-modern">
                            <div class="task-title-modern">{{ task.title }}</div>
                            <div class="task-meta-modern" style="color: #ef4444; font-weight: 600;">
                                <span><i class="fas fa-clock"></i> Due: {{ task.due_date|date:"M d, g:i A" }}</span>
                            </div>
                        </div>
                        <div class="task-badges-modern">
                            <span class="badge-modern badge-priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="empty-title">No upcoming deadlines</div>
                    <div class="empty-text">You're all caught up!</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
// Toast System
function showToast(message, type) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    // Status Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['To Do', 'In Progress', 'In Review', 'Completed', 'Blocked'],
                datasets: [{
                    data: [
                        {{ todo_tasks|default:0 }},
                        {{ in_progress_tasks|default:0 }},
                        {{ in_review_tasks|default:0 }},
                        {{ completed_tasks|default:0 }},
                        {{ blocked_tasks|default:0 }}
                    ],
                    backgroundColor: ['#94a3b8', '#3b82f6', '#8b5cf6', '#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: { size: 13, weight: '600' }
                        }
                    }
                }
            }
        });
    }

    // Priority Chart
    const priorityCtx = document.getElementById('priorityChart');
    if (priorityCtx) {
        new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High', 'Urgent'],
                datasets: [{
                    label: 'Tasks',
                    data: [
                        {{ low_priority_tasks|default:0 }},
                        {{ medium_priority_tasks|default:0 }},
                        {{ high_priority_tasks|default:0 }},
                        {{ urgent_priority_tasks|default:0 }}
                    ],
                    backgroundColor: ['#94a3b8', '#3b82f6', '#f59e0b', '#ef4444'],
                    borderRadius: 12,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f1f5f9' },
                        ticks: { font: { weight: '600' } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { weight: '700' } }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
